
<!DOCTYPE HTML>
<html lang="zh-cn">
<head>
  <meta charset="UTF-8">
  <title>葱丝瓣酱</title>

  <meta name="author" content="Xiaocong He">
  
  <meta name="description" content="介绍 Android DropBoxManager Service Nov 21st, 2012 什么是 DropBoxManager ? Enqueues chunks of data (from various sources &#8211; application crashes, &hellip;">
  
  

  <link rel="canonical" href="http://xiaocong.github.com">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="葱丝瓣酱" type="application/atom+xml">
</head>
  
<body class="default">
  <div id="wrapper">
    <div id="header">
  <h1><a href="/">葱丝瓣酱</a></h1>
  
    <p>你真的需要呼吸吗?!</p>
  
</div>
<ul id="social-links">
  
    <li><a class="feed" href="/atom.xml" title="RSS">RSS</a></li>
  
  
    <li><a class="twitter" href="http://twitter.com/xiaocong" title="Twitter">Twitter</a></li>
  
  
    <li> <a class="github" href="https://github.com/xiaocong" title="GitHub">GitHub</a> </li>
  
</ul>
<div class="clear"></div>
<ul id="nav">
  
    <li> <a href="/" class="current">blog</a> </li>
  

  
    <li><a href="/blog/archives">archives</a></li>
  
</ul>

    <div id="main"> 

  
  <div class="post"> <div class="post-header">
  
    <h1 class="post-title">
      <a href="/blog/2012/11/21/to-introduce-android-dropboxmanager-service/">介绍 Android DropBoxManager Service</a>
    </h1>
  
  








  


<time datetime="2012-11-21T11:59:00+08:00" pubdate data-updated="true">Nov 21<span>st</span>, 2012</time>
</div>

<div class="post-content"><h2>什么是 DropBoxManager ?</h2>

<blockquote><p>Enqueues chunks of data (from various sources &#8211; application crashes, kernel log records, etc.). The queue is size bounded and will drop old data if the enqueued data exceeds the maximum size. You can think of this as a persistent, system-wide, blob-oriented &#8220;logcat&#8221;.</p></blockquote>


<p>DropBoxManager 是 <a href="http://www.android.com">Android</a> 在 Froyo(API level 8) 引入的用来持续化存储系统数据的机制, 主要用于记录
Android 运行过程中, 内核, 系统进程, 用户进程等出现严重问题时的 log, 可以认为这是一个可持续存储的系统级别的
<a href="http://developer.android.com/tools/help/logcat.html">logcat</a>.</p>

<p>我们可以通过用参数 <a href="http://developer.android.com/reference/android/content/Context.html#DROPBOX_SERVICE">DROPBOX_SERVICE</a>
调用 <a href="http://developer.android.com/reference/android/content/Context.html#getSystemService(java.lang.String">getSystemService(String)</a>
来获得这个服务, 并查询出所有存储在 DropBoxManager 里的系统错误记录.</p>

<h2>Android 缺省能记录哪些系统错误 ?</h2>

<p>我没有在官方的网站上找到关于哪些系统错误会被记录到 DropBoxManager 中的文档, 但我们可以查看源代码来找到相关信息.
从源代码中可以查找到记录到 DropBoxManager 中各种 <code>tag</code>(类似于 logcat 的 <code>tag</code>).</p>

<h3>crash (应用程序强制关闭, Force Close)</h3>

<p>当Java层遇到未被 catch 的例外时, ActivityManagerService 会记录一次 <code>crash</code> 到 DropBoxManager中, 并弹出 <code>Force Close</code> 对话框提示用户.</p>

<figure class='code'><figcaption><span>ActivityManagerService </span><a href='https://android.googlesource.com/platform/frameworks/base/+/refs/tags/android-4.2_r1/services/java/com/android/server/am/ActivityManagerService.java'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleApplicationCrash</span><span class="o">(</span><span class="n">IBinder</span> <span class="n">app</span><span class="o">,</span> <span class="n">ApplicationErrorReport</span><span class="o">.</span><span class="na">CrashInfo</span> <span class="n">crashInfo</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">ProcessRecord</span> <span class="n">r</span> <span class="o">=</span> <span class="n">findAppProcess</span><span class="o">(</span><span class="n">app</span><span class="o">,</span> <span class="s">&quot;Crash&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="kd">final</span> <span class="n">String</span> <span class="n">processName</span> <span class="o">=</span> <span class="n">app</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="s">&quot;system_server&quot;</span>
</span><span class='line'>            <span class="o">:</span> <span class="o">(</span><span class="n">r</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="s">&quot;unknown&quot;</span> <span class="o">:</span> <span class="n">r</span><span class="o">.</span><span class="na">processName</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">EventLog</span><span class="o">.</span><span class="na">writeEvent</span><span class="o">(</span><span class="n">EventLogTags</span><span class="o">.</span><span class="na">AM_CRASH</span><span class="o">,</span> <span class="n">Binder</span><span class="o">.</span><span class="na">getCallingPid</span><span class="o">(),</span>
</span><span class='line'>            <span class="n">UserHandle</span><span class="o">.</span><span class="na">getUserId</span><span class="o">(</span><span class="n">Binder</span><span class="o">.</span><span class="na">getCallingUid</span><span class="o">()),</span> <span class="n">processName</span><span class="o">,</span>
</span><span class='line'>            <span class="n">r</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="n">r</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">flags</span><span class="o">,</span>
</span><span class='line'>            <span class="n">crashInfo</span><span class="o">.</span><span class="na">exceptionClassName</span><span class="o">,</span>
</span><span class='line'>            <span class="n">crashInfo</span><span class="o">.</span><span class="na">exceptionMessage</span><span class="o">,</span>
</span><span class='line'>            <span class="n">crashInfo</span><span class="o">.</span><span class="na">throwFileName</span><span class="o">,</span>
</span><span class='line'>            <span class="n">crashInfo</span><span class="o">.</span><span class="na">throwLineNumber</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">addErrorToDropBox</span><span class="o">(</span><span class="s">&quot;crash&quot;</span><span class="o">,</span> <span class="n">r</span><span class="o">,</span> <span class="n">processName</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">crashInfo</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">crashApplication</span><span class="o">(</span><span class="n">r</span><span class="o">,</span> <span class="n">crashInfo</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>




<!--more-->


<h3>anr (应用程序没响应, Application Not Responding, ANR)</h3>

<p>当应用程序的主线程(UI线程)长时间未能得到响应时, ActivityManagerService 会记录一次 <code>anr</code> 到 DropBoxManager中, 并弹出 <code>Application Not Responding</code> 对话框提示用户.</p>

<figure class='code'><figcaption><span>ActivityManagerService </span><a href='https://android.googlesource.com/platform/frameworks/base/+/refs/tags/android-4.2_r1/services/java/com/android/server/am/ActivityManagerService.java'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">final</span> <span class="kt">void</span> <span class="nf">appNotResponding</span><span class="o">(</span><span class="n">ProcessRecord</span> <span class="n">app</span><span class="o">,</span> <span class="n">ActivityRecord</span> <span class="n">activity</span><span class="o">,</span>
</span><span class='line'>        <span class="n">ActivityRecord</span> <span class="n">parent</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">aboveSystem</span><span class="o">,</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">annotation</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="c1">//......</span>
</span><span class='line'>    <span class="n">addErrorToDropBox</span><span class="o">(</span><span class="s">&quot;anr&quot;</span><span class="o">,</span> <span class="n">app</span><span class="o">,</span> <span class="n">app</span><span class="o">.</span><span class="na">processName</span><span class="o">,</span> <span class="n">activity</span><span class="o">,</span> <span class="n">parent</span><span class="o">,</span> <span class="n">annotation</span><span class="o">,</span>
</span><span class='line'>            <span class="n">cpuInfo</span><span class="o">,</span> <span class="n">tracesFile</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</span><span class='line'>    <span class="c1">//......</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>wtf (What a Terrible Failure)</h3>

<p>&#8216;android.util.Log&#8217; 类提供了静态的 <code>wtf</code> 函数, 应用程序可以在代码中用来主动报告一个不应当发生的情况. 依赖于系统设置,
这个函数会通过 ActivityManagerService 增加一个 <code>wtf</code> 记录到 DropBoxManager中, 并/或终止当前应用程序进程.</p>

<figure class='code'><figcaption><span>ActivityManagerService </span><a href='https://android.googlesource.com/platform/frameworks/base/+/refs/tags/android-4.2_r1/services/java/com/android/server/am/ActivityManagerService.java'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">handleApplicationWtf</span><span class="o">(</span><span class="n">IBinder</span> <span class="n">app</span><span class="o">,</span> <span class="n">String</span> <span class="n">tag</span><span class="o">,</span>
</span><span class='line'>        <span class="n">ApplicationErrorReport</span><span class="o">.</span><span class="na">CrashInfo</span> <span class="n">crashInfo</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">ProcessRecord</span> <span class="n">r</span> <span class="o">=</span> <span class="n">findAppProcess</span><span class="o">(</span><span class="n">app</span><span class="o">,</span> <span class="s">&quot;WTF&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="kd">final</span> <span class="n">String</span> <span class="n">processName</span> <span class="o">=</span> <span class="n">app</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="s">&quot;system_server&quot;</span>
</span><span class='line'>            <span class="o">:</span> <span class="o">(</span><span class="n">r</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="s">&quot;unknown&quot;</span> <span class="o">:</span> <span class="n">r</span><span class="o">.</span><span class="na">processName</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">EventLog</span><span class="o">.</span><span class="na">writeEvent</span><span class="o">(</span><span class="n">EventLogTags</span><span class="o">.</span><span class="na">AM_WTF</span><span class="o">,</span>
</span><span class='line'>            <span class="n">UserHandle</span><span class="o">.</span><span class="na">getUserId</span><span class="o">(</span><span class="n">Binder</span><span class="o">.</span><span class="na">getCallingUid</span><span class="o">()),</span> <span class="n">Binder</span><span class="o">.</span><span class="na">getCallingPid</span><span class="o">(),</span>
</span><span class='line'>            <span class="n">processName</span><span class="o">,</span>
</span><span class='line'>            <span class="n">r</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="n">r</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">flags</span><span class="o">,</span>
</span><span class='line'>            <span class="n">tag</span><span class="o">,</span> <span class="n">crashInfo</span><span class="o">.</span><span class="na">exceptionMessage</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">addErrorToDropBox</span><span class="o">(</span><span class="s">&quot;wtf&quot;</span><span class="o">,</span> <span class="n">r</span><span class="o">,</span> <span class="n">processName</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">tag</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">crashInfo</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">r</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">r</span><span class="o">.</span><span class="na">pid</span> <span class="o">!=</span> <span class="n">Process</span><span class="o">.</span><span class="na">myPid</span><span class="o">()</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>            <span class="n">Settings</span><span class="o">.</span><span class="na">Global</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="n">mContext</span><span class="o">.</span><span class="na">getContentResolver</span><span class="o">(),</span>
</span><span class='line'>                    <span class="n">Settings</span><span class="o">.</span><span class="na">Global</span><span class="o">.</span><span class="na">WTF_IS_FATAL</span><span class="o">,</span> <span class="mi">0</span><span class="o">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">crashApplication</span><span class="o">(</span><span class="n">r</span><span class="o">,</span> <span class="n">crashInfo</span><span class="o">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>strict_mode (StrictMode Violation)</h3>

<p><a href="http://developer.android.com/reference/android/os/StrictMode.html">StrictMode</a> (严格模式), 顾名思义, 就是在比正常模式检测得更严格, 通常用来监测不应当在主线程执行的网络, 文件等操作.
任何 StrictMode 违例都会被 ActivityManagerService 在 DropBoxManager 中记录为一次 <code>strict_mode</code> 违例.</p>

<figure class='code'><figcaption><span>ActivityManagerService </span><a href='https://android.googlesource.com/platform/frameworks/base/+/refs/tags/android-4.2_r1/services/java/com/android/server/am/ActivityManagerService.java'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleApplicationStrictModeViolation</span><span class="o">(</span>
</span><span class='line'>        <span class="n">IBinder</span> <span class="n">app</span><span class="o">,</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">violationMask</span><span class="o">,</span>
</span><span class='line'>        <span class="n">StrictMode</span><span class="o">.</span><span class="na">ViolationInfo</span> <span class="n">info</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">ProcessRecord</span> <span class="n">r</span> <span class="o">=</span> <span class="n">findAppProcess</span><span class="o">(</span><span class="n">app</span><span class="o">,</span> <span class="s">&quot;StrictMode&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">r</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="o">((</span><span class="n">violationMask</span> <span class="o">&amp;</span> <span class="n">StrictMode</span><span class="o">.</span><span class="na">PENALTY_DROPBOX</span><span class="o">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">Integer</span> <span class="n">stackFingerprint</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="na">hashCode</span><span class="o">();</span>
</span><span class='line'>        <span class="kt">boolean</span> <span class="n">logIt</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span><span class='line'>        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mAlreadyLoggedViolatedStacks</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">mAlreadyLoggedViolatedStacks</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">stackFingerprint</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">logIt</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span><span class='line'>                <span class="c1">// TODO: sub-sample into EventLog for these, with</span>
</span><span class='line'>                <span class="c1">// the info.durationMillis?  Then we&#39;d get</span>
</span><span class='line'>                <span class="c1">// the relative pain numbers, without logging all</span>
</span><span class='line'>                <span class="c1">// the stack traces repeatedly.  We&#39;d want to do</span>
</span><span class='line'>                <span class="c1">// likewise in the client code, which also does</span>
</span><span class='line'>                <span class="c1">// dup suppression, before the Binder call.</span>
</span><span class='line'>            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">mAlreadyLoggedViolatedStacks</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;=</span> <span class="n">MAX_DUP_SUPPRESSED_STACKS</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                    <span class="n">mAlreadyLoggedViolatedStacks</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>                <span class="n">mAlreadyLoggedViolatedStacks</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">stackFingerprint</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">logIt</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">logStrictModeViolationToDropBox</span><span class="o">(</span><span class="n">r</span><span class="o">,</span> <span class="n">info</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="c1">//......</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>lowmem (低内存)</h3>

<p>在内存不足的时候, Android 会终止后台应用程序来释放内存, 但如果没有后台应用程序可被释放时, ActivityManagerService 就会在 DropBoxManager 中记录一次 <code>lowmem</code>.</p>

<figure class='code'><figcaption><span>ActivityManagerService </span><a href='https://android.googlesource.com/platform/frameworks/base/+/refs/tags/android-4.2_r1/services/java/com/android/server/am/ActivityManagerService.java'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleMessage</span><span class="o">(</span><span class="n">Message</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">switch</span> <span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">what</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="c1">//...</span>
</span><span class='line'>        <span class="k">case</span> <span class="nl">REPORT_MEM_USAGE:</span> <span class="o">{</span>
</span><span class='line'>            <span class="c1">//......</span>
</span><span class='line'>            <span class="n">Thread</span> <span class="n">thread</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>                <span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">void</span> <span class="n">run</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>                    <span class="n">StringBuilder</span> <span class="n">dropBuilder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">(</span><span class="mi">1024</span><span class="o">);</span>
</span><span class='line'>                    <span class="n">StringBuilder</span> <span class="n">logBuilder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">(</span><span class="mi">1024</span><span class="o">);</span>
</span><span class='line'>                    <span class="c1">//......</span>
</span><span class='line'>                    <span class="n">addErrorToDropBox</span><span class="o">(</span><span class="s">&quot;lowmem&quot;</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="s">&quot;system_server&quot;</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span>
</span><span class='line'>                            <span class="kc">null</span><span class="o">,</span> <span class="n">tag</span><span class="o">.</span><span class="na">toString</span><span class="o">(),</span> <span class="n">dropBuilder</span><span class="o">.</span><span class="na">toString</span><span class="o">(),</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</span><span class='line'>                    <span class="c1">//......</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>            <span class="o">};</span>
</span><span class='line'>            <span class="n">thread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span><span class='line'>            <span class="k">break</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="c1">//......</span>
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>watchdog</h3>

<p>如果 WatchDog 监测到系统进程(<code>system_server</code>)出现问题, 会增加一条 <code>watchdog</code> 记录到 DropBoxManager 中, 并终止系统进程的执行.</p>

<figure class='code'><figcaption><span>Watchdog </span><a href='https://android.googlesource.com/platform/frameworks/base/+/refs/tags/android-4.2_r1/services/java/com/android/server/Watchdog.java'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="cm">/** This class calls its monitor every minute. Killing this process if they don&#39;t return **/</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Watchdog</span> <span class="kd">extends</span> <span class="n">Thread</span> <span class="o">{</span>
</span><span class='line'>    <span class="c1">//......</span>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="kt">boolean</span> <span class="n">waitedHalf</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span><span class='line'>        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="c1">//......</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// If we got here, that means that the system is most likely hung.</span>
</span><span class='line'>            <span class="c1">// First collect stack traces from all threads of the system process.</span>
</span><span class='line'>            <span class="c1">// Then kill this process so that the system will restart.</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">//......</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// Try to add the error to the dropbox, but assuming that the ActivityManager</span>
</span><span class='line'>            <span class="c1">// itself may be deadlocked.  (which has happened, causing this statement to</span>
</span><span class='line'>            <span class="c1">// deadlock and the watchdog as a whole to be ineffective)</span>
</span><span class='line'>            <span class="n">Thread</span> <span class="n">dropboxThread</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(</span><span class="s">&quot;watchdogWriteToDropbox&quot;</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>                        <span class="n">mActivity</span><span class="o">.</span><span class="na">addErrorToDropBox</span><span class="o">(</span>
</span><span class='line'>                                <span class="s">&quot;watchdog&quot;</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="s">&quot;system_server&quot;</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span>
</span><span class='line'>                                <span class="n">name</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">stack</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</span><span class='line'>                    <span class="o">}</span>
</span><span class='line'>                <span class="o">};</span>
</span><span class='line'>            <span class="n">dropboxThread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span><span class='line'>            <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">dropboxThread</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="mi">2000</span><span class="o">);</span>  <span class="c1">// wait up to 2 seconds for it to return.</span>
</span><span class='line'>            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">ignored</span><span class="o">)</span> <span class="o">{}</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">//......</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//......</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>netstats_error</h3>

<p>NetworkStatsService 负责收集并持久化存储网络状态的统计数据, 当遇到明显的网络状态错误时, 它会增加一条 <code>netstats_error</code> 记录到 DropBoxManager.</p>

<h3>BATTERY_DISCHARGE_INFO</h3>

<p>BatteryService 负责检测充电状态, 并更新手机电池信息. 当遇到明显的 discharge 事件, 它会增加一条 <code>BATTERY_DISCHARGE_INFO</code> 记录到 DropBoxManager.</p>

<h3>系统服务(System Serve)启动完成后的检测</h3>

<p>系统服务(System Serve)启动完成后会进行一系列自检, 包括:</p>

<ul>
<li><p>开机</p>

<p>每次开机都会增加一条 <code>SYSTEM_BOOT</code> 记录.</p></li>
<li><p>System Server 重启</p>

<p>如果系统服务(System Server)不是开机后的第一次启动, 会增加一条 <code>SYSTEM_RESTART</code> 记录, 正常情况下系统服务(System Server)在一次开机中只会启动一次,
启动第二次就意味着 bug.</p></li>
<li><p>Kernel Panic (内核错误)</p>

<p>发生 Kernel Panic 时, Kernel 会记录一些 log 信息到文件系统, 因为 Kernel 已经挂掉了, 当然这时不可能有其他机会来记录错误信息了. 唯一能检测 Kernel Panic
的办法就是在手机启动后检查这些 log 文件是否存在, 如果存在则意味着上一次手机是因为 Kernel Panic 而宕机, 并记录这些日志到 DropBoxManager 中.
DropBoxManager 记录 TAG 名称和对应的文件名分别是:</p>

<ul>
<li><code>SYSTEM_LAST_KMSG</code>, 如果 <code>/proc/last_kmsg</code> 存在.</li>
<li><code>APANIC_CONSOLE</code>, 如果 <code>/data/dontpanic/apanic_console</code> 存在.</li>
<li><code>APANIC_THREADS</code>, 如果 <code>/data/dontpanic/apanic_threads</code> 存在.</li>
</ul>
</li>
<li><p>系统恢复(System Recovery)</p>

<p>通过检测文件 <code>/cache/recovery/log</code> 是否存在来检测设备是否因为系统恢复而重启, 并增加一条 <code>SYSTEM_RECOVERY_LOG</code> 记录到 DropBoxManager 中.</p></li>
</ul>


<figure class='code'><figcaption><span>System Server BootReceiver </span><a href='https://android.googlesource.com/platform/frameworks/base/+/refs/tags/android-4.2_r1/services/java/com/android/server/BootReceiver.java'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="kt">void</span> <span class="nf">logBootEvents</span><span class="o">(</span><span class="n">Context</span> <span class="n">ctx</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">final</span> <span class="n">DropBoxManager</span> <span class="n">db</span> <span class="o">=</span> <span class="o">(</span><span class="n">DropBoxManager</span><span class="o">)</span> <span class="n">ctx</span><span class="o">.</span><span class="na">getSystemService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">DROPBOX_SERVICE</span><span class="o">);</span>
</span><span class='line'>    <span class="kd">final</span> <span class="n">SharedPreferences</span> <span class="n">prefs</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="na">getSharedPreferences</span><span class="o">(</span><span class="s">&quot;log_files&quot;</span><span class="o">,</span> <span class="n">Context</span><span class="o">.</span><span class="na">MODE_PRIVATE</span><span class="o">);</span>
</span><span class='line'>    <span class="kd">final</span> <span class="n">String</span> <span class="n">headers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">(</span><span class="mi">512</span><span class="o">)</span>
</span><span class='line'>        <span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;Build: &quot;</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">Build</span><span class="o">.</span><span class="na">FINGERPRINT</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;\n&quot;</span><span class="o">)</span>
</span><span class='line'>        <span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;Hardware: &quot;</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">Build</span><span class="o">.</span><span class="na">BOARD</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;\n&quot;</span><span class="o">)</span>
</span><span class='line'>        <span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;Revision: &quot;</span><span class="o">)</span>
</span><span class='line'>        <span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">SystemProperties</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;ro.revision&quot;</span><span class="o">,</span> <span class="s">&quot;&quot;</span><span class="o">)).</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;\n&quot;</span><span class="o">)</span>
</span><span class='line'>        <span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;Bootloader: &quot;</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">Build</span><span class="o">.</span><span class="na">BOOTLOADER</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;\n&quot;</span><span class="o">)</span>
</span><span class='line'>        <span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;Radio: &quot;</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="n">Build</span><span class="o">.</span><span class="na">RADIO</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;\n&quot;</span><span class="o">)</span>
</span><span class='line'>        <span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;Kernel: &quot;</span><span class="o">)</span>
</span><span class='line'>        <span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">FileUtils</span><span class="o">.</span><span class="na">readTextFile</span><span class="o">(</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s">&quot;/proc/version&quot;</span><span class="o">),</span> <span class="mi">1024</span><span class="o">,</span> <span class="s">&quot;...\n&quot;</span><span class="o">))</span>
</span><span class='line'>        <span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;\n&quot;</span><span class="o">).</span><span class="na">toString</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">String</span> <span class="n">recovery</span> <span class="o">=</span> <span class="n">RecoverySystem</span><span class="o">.</span><span class="na">handleAftermath</span><span class="o">();</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">recovery</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">db</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">db</span><span class="o">.</span><span class="na">addText</span><span class="o">(</span><span class="s">&quot;SYSTEM_RECOVERY_LOG&quot;</span><span class="o">,</span> <span class="n">headers</span> <span class="o">+</span> <span class="n">recovery</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">SystemProperties</span><span class="o">.</span><span class="na">getLong</span><span class="o">(</span><span class="s">&quot;ro.runtime.firstboot&quot;</span><span class="o">,</span> <span class="mi">0</span><span class="o">)</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">String</span> <span class="n">now</span> <span class="o">=</span> <span class="n">Long</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">());</span>
</span><span class='line'>        <span class="n">SystemProperties</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="s">&quot;ro.runtime.firstboot&quot;</span><span class="o">,</span> <span class="n">now</span><span class="o">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">db</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">db</span><span class="o">.</span><span class="na">addText</span><span class="o">(</span><span class="s">&quot;SYSTEM_BOOT&quot;</span><span class="o">,</span> <span class="n">headers</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Negative sizes mean to take the *tail* of the file (see FileUtils.readTextFile())</span>
</span><span class='line'>        <span class="n">addFileToDropBox</span><span class="o">(</span><span class="n">db</span><span class="o">,</span> <span class="n">prefs</span><span class="o">,</span> <span class="n">headers</span><span class="o">,</span> <span class="s">&quot;/proc/last_kmsg&quot;</span><span class="o">,</span>
</span><span class='line'>                <span class="o">-</span><span class="n">LOG_SIZE</span><span class="o">,</span> <span class="s">&quot;SYSTEM_LAST_KMSG&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="n">addFileToDropBox</span><span class="o">(</span><span class="n">db</span><span class="o">,</span> <span class="n">prefs</span><span class="o">,</span> <span class="n">headers</span><span class="o">,</span> <span class="s">&quot;/cache/recovery/log&quot;</span><span class="o">,</span>
</span><span class='line'>                <span class="o">-</span><span class="n">LOG_SIZE</span><span class="o">,</span> <span class="s">&quot;SYSTEM_RECOVERY_LOG&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="n">addFileToDropBox</span><span class="o">(</span><span class="n">db</span><span class="o">,</span> <span class="n">prefs</span><span class="o">,</span> <span class="n">headers</span><span class="o">,</span> <span class="s">&quot;/data/dontpanic/apanic_console&quot;</span><span class="o">,</span>
</span><span class='line'>                <span class="o">-</span><span class="n">LOG_SIZE</span><span class="o">,</span> <span class="s">&quot;APANIC_CONSOLE&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="n">addFileToDropBox</span><span class="o">(</span><span class="n">db</span><span class="o">,</span> <span class="n">prefs</span><span class="o">,</span> <span class="n">headers</span><span class="o">,</span> <span class="s">&quot;/data/dontpanic/apanic_threads&quot;</span><span class="o">,</span>
</span><span class='line'>                <span class="o">-</span><span class="n">LOG_SIZE</span><span class="o">,</span> <span class="s">&quot;APANIC_THREADS&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">db</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">db</span><span class="o">.</span><span class="na">addText</span><span class="o">(</span><span class="s">&quot;SYSTEM_RESTART&quot;</span><span class="o">,</span> <span class="n">headers</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Scan existing tombstones (in case any new ones appeared)</span>
</span><span class='line'>    <span class="n">File</span><span class="o">[]</span> <span class="n">tombstoneFiles</span> <span class="o">=</span> <span class="n">TOMBSTONE_DIR</span><span class="o">.</span><span class="na">listFiles</span><span class="o">();</span>
</span><span class='line'>    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">tombstoneFiles</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tombstoneFiles</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">addFileToDropBox</span><span class="o">(</span><span class="n">db</span><span class="o">,</span> <span class="n">prefs</span><span class="o">,</span> <span class="n">headers</span><span class="o">,</span> <span class="n">tombstoneFiles</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">getPath</span><span class="o">(),</span>
</span><span class='line'>                <span class="n">LOG_SIZE</span><span class="o">,</span> <span class="s">&quot;SYSTEM_TOMBSTONE&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Start watching for new tombstone files; will record them as they occur.</span>
</span><span class='line'>    <span class="c1">// This gets registered with the singleton file observer thread.</span>
</span><span class='line'>    <span class="n">sTombstoneObserver</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileObserver</span><span class="o">(</span><span class="n">TOMBSTONE_DIR</span><span class="o">.</span><span class="na">getPath</span><span class="o">(),</span> <span class="n">FileObserver</span><span class="o">.</span><span class="na">CLOSE_WRITE</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="nd">@Override</span>
</span><span class='line'>        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onEvent</span><span class="o">(</span><span class="kt">int</span> <span class="n">event</span><span class="o">,</span> <span class="n">String</span> <span class="n">path</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">String</span> <span class="n">filename</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">TOMBSTONE_DIR</span><span class="o">,</span> <span class="n">path</span><span class="o">).</span><span class="na">getPath</span><span class="o">();</span>
</span><span class='line'>                <span class="n">addFileToDropBox</span><span class="o">(</span><span class="n">db</span><span class="o">,</span> <span class="n">prefs</span><span class="o">,</span> <span class="n">headers</span><span class="o">,</span> <span class="n">filename</span><span class="o">,</span> <span class="n">LOG_SIZE</span><span class="o">,</span> <span class="s">&quot;SYSTEM_TOMBSTONE&quot;</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">Slog</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;Can&#39;t log tombstone&quot;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">};</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">sTombstoneObserver</span><span class="o">.</span><span class="na">startWatching</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>SYSTEM_TOMBSTONE (Native 进程的崩溃)</h3>

<p>Tombstone 是 Android 用来记录 native 进程崩溃的 <code>core dump</code> 日志, 系统服务在启动完成后会增加一个 Observer 来侦测 tombstone 日志文件的变化,
每当生成新的 <code>tombstone</code> 文件, 就会增加一条 <code>SYSTEM_TOMBSTONE</code> 记录到 DropBoxManager 中.</p>

<h2>DropBoxManager 如何存储记录数据 ?</h2>

<p>DropBoxManager 使用的是文件存储, 所有的记录都存储在 <code>/data/system/dropbox</code> 目录中, 一条记录就是一个文件, 当文本文件的尺寸超过文件系统的最小区块尺寸后,
DropBoxManager 还会自动压缩该文件, 通常文件名以调用 DropBoxManager 的 TAG 参数开头.</p>

<figure class='code'><figcaption><span>System Server BootReceiver </span><a href='https://android.googlesource.com/platform/frameworks/base/+/refs/tags/android-4.2_r1/services/java/com/android/server/BootReceiver.java'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">$</span> <span class="n">adb</span> <span class="n">shell</span> <span class="n">ls</span> <span class="o">-</span><span class="n">l</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">dropbox</span>
</span><span class='line'><span class="o">-</span><span class="n">rw</span><span class="o">-------</span> <span class="n">system</span>   <span class="n">system</span>        <span class="mi">258</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">21</span> <span class="mi">11</span><span class="o">:</span><span class="mi">36</span> <span class="n">SYSTEM_RESTART</span><span class="err">@</span><span class="mi">1353469017940</span><span class="o">.</span><span class="na">txt</span>
</span><span class='line'><span class="o">-</span><span class="n">rw</span><span class="o">-------</span> <span class="n">system</span>   <span class="n">system</span>         <span class="mi">39</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">21</span> <span class="mi">11</span><span class="o">:</span><span class="mi">40</span> <span class="n">event_data</span><span class="err">@</span><span class="mi">1353469222884</span><span class="o">.</span><span class="na">txt</span>
</span><span class='line'><span class="o">-</span><span class="n">rw</span><span class="o">-------</span> <span class="n">system</span>   <span class="n">system</span>         <span class="mi">39</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">21</span> <span class="mi">12</span><span class="o">:</span><span class="mi">10</span> <span class="n">event_data</span><span class="err">@</span><span class="mi">1353471022975</span><span class="o">.</span><span class="na">txt</span>
</span><span class='line'><span class="o">-</span><span class="n">rw</span><span class="o">-------</span> <span class="n">system</span>   <span class="n">system</span>         <span class="mi">34</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">21</span> <span class="mi">18</span><span class="o">:</span><span class="mi">10</span> <span class="n">event_log</span><span class="err">@</span><span class="mi">1353492624170</span><span class="o">.</span><span class="na">txt</span>
</span><span class='line'><span class="o">-</span><span class="n">rw</span><span class="o">-------</span> <span class="n">system</span>   <span class="n">system</span>         <span class="mi">34</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">21</span> <span class="mi">18</span><span class="o">:</span><span class="mi">40</span> <span class="n">event_log</span><span class="err">@</span><span class="mi">1353494424296</span><span class="o">.</span><span class="na">txt</span>
</span><span class='line'><span class="o">-</span><span class="n">rw</span><span class="o">-------</span> <span class="n">system</span>   <span class="n">system</span>         <span class="mi">34</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">22</span> <span class="mi">10</span><span class="o">:</span><span class="mi">10</span> <span class="n">event_log</span><span class="err">@</span><span class="mi">1353550227432</span><span class="o">.</span><span class="na">txt</span>
</span><span class='line'><span class="o">-</span><span class="n">rw</span><span class="o">-------</span> <span class="n">system</span>   <span class="n">system</span>       <span class="mi">1528</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">21</span> <span class="mi">22</span><span class="o">:</span><span class="mi">54</span> <span class="n">system_app_crash</span><span class="err">@</span><span class="mi">1353509648395</span><span class="o">.</span><span class="na">txt</span>
</span><span class='line'><span class="o">-</span><span class="n">rw</span><span class="o">-------</span> <span class="n">system</span>   <span class="n">system</span>       <span class="mi">1877</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">21</span> <span class="mi">11</span><span class="o">:</span><span class="mi">36</span> <span class="n">system_app_strictmode</span><span class="err">@</span><span class="mi">1353469014395</span><span class="o">.</span><span class="na">txt</span>
</span><span class='line'><span class="o">-</span><span class="n">rw</span><span class="o">-------</span> <span class="n">system</span>   <span class="n">system</span>       <span class="mi">3724</span> <span class="mi">2012</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">21</span> <span class="mi">11</span><span class="o">:</span><span class="mi">36</span> <span class="n">system_app_strictmode</span><span class="err">@</span><span class="mi">1353469014924</span><span class="o">.</span><span class="na">txt</span><span class="o">.</span><span class="na">gz</span>
</span></code></pre></td></tr></table></div></figure>


<h2>如何利用 DropBoxManager ?</h2>

<ul>
<li><p>利用 DropBoxManager 来记录需要持久化存储的错误日志信息</p>

<p>DropBoxManager 提供了 logcat 之外的另外一种错误日志记录机制, 程序可以在出错的时候自动将相关信息记录到 DropBoxManager 中. 相对于 logcat,
DropBoxManager 更适合于程序的自动抓错, 避免人为因素而产生的错误遗漏. 并且 DropBoxManager 是 Android 系统的公开服务, 相对于很多私有实现,
出现兼容性问题的几率会大大降低.</p></li>
<li><p>错误自动上报</p>

<p>可以将 DropBoxManager 和设备的 BugReport 结合起来, 实现自动上报错误到服务器. 每当生成新的记录, DropBoxManager 就会广播一个
<code>DropBoxManager.ACTION_DROPBOX_ENTRY_ADDED</code> Intent, 设备的 BugReport 服务需要侦听这个 Intent, 然后触发错误的自动上报.</p></li>
</ul>


<h2>参考</h2>

<ul>
<li><a href="http://www.android.com">Android Official Site</a></li>
<li><a href="http://developer.android.com/reference/android/os/DropBoxManager.html">DropBoxManager Overview</a></li>
<li><a href="http://developer.android.com/reference/android/app/ActivityManager.html">ActivityManager Service Overview</a></li>
<li><a href="http://developer.android.com/reference/android/os/StrictMode.html">Android StrictMode Overview</a></li>
</ul>

</div>
 </div>

  
  <div class="post"> <div class="post-header">
  
    <h1 class="post-title">
      <a href="/blog/2012/10/16/yeoman-a-new-javascript-build-tool/">Yeoman: 一个新的 Javascript 构建工具</a>
    </h1>
  
  








  


<time datetime="2012-10-16T12:59:00+08:00" pubdate data-updated="true">Oct 16<span>th</span>, 2012</time>
</div>

<div class="post-content"><p><a href="http://gruntjs.com/" title="Grunt is a task-based command line build tool for JavaScript projects.">Grunt</a> 是一个非常优秀的 Javascript 构建工具, 虽然它的 Build-in 的任务非常有限, 但是它提供了一套非常灵活的插件机制, 可以进行任务扩展. 目前在官网上的第三方任务插件数目已经达到 160+, 并且在持续增长中&#8230; 对于通用的功能基本上都能找到对应的任务插件, 当然你也可以自己写扩展任务来满足特殊的构建需求.</p>

<p>我通常会直接使用 <a href="https://github.com/backbone-boilerplate/grunt-bbb" title="Backbone Boilerplate framework tool.">bbb</a>, 因为 <a href="https://github.com/backbone-boilerplate/grunt-bbb" title="Backbone Boilerplate framework tool.">bbb</a> 已经收集齐了我想用到的任务插件, 非常顺手.</p>

<p>对我而言 <a href="https://github.com/backbone-boilerplate/grunt-bbb" title="Backbone Boilerplate framework tool.">bbb</a> 已经足够用了, 尽管这样, 在第一次尝试 <a href="http://yeoman.io/" title="Yeoman is a robust and opinionated set of tools, libraries, and a workflow that can help developers quickly build beautiful, compelling web apps.">Yeoman</a> 之后, 我还是忍不住想向大家推荐这个新的工具.</p>

<blockquote><p>Yeoman is a robust and opinionated client-side stack, comprised of tools and frameworks that can help developers quickly build beautiful web applications. We take care of providing everything needed to get started without any of the normal headaches associated with a manual setup.<br/>With a modular architecture that can scale out of the box, we leverage the success and lessons learned from several open-source communities to ensure the stack developers use is as intelligent as possible.<br/>As firm believers in good documentation and well thought out build processes, Yeoman includes support for linting, testing, minification and much more, so developers can focus on solutions rather than worrying about the little things.<br/>Yeoman is fast, performant and is optimized to work best in modern browsers.</p><footer><strong>Yeoman Community</strong> <cite><a href='http://yeoman.io/whyyeoman.html'>WHY YEOMAN?</a></cite></footer></blockquote>


<p>想对比其他 Javascript 构建工具, Yeoman 具有下面非常吸引人的特点:</p>

<h2>根据定制模板快速生成程序框架</h2>

<p><a href="http://yeoman.io/" title="Yeoman is a robust and opinionated set of tools, libraries, and a workflow that can help developers quickly build beautiful, compelling web apps.">Yeoman</a> 能根据你选择的框架初始化生成程序框架, 目前已经支持大量的程序模板, 看趋势似乎是想把所有框架的初始化模板都包含进去:</p>

<pre><code>Yeoman:
  generator
  controller

Angular:
  angular:service
  angular:all
  angular:directive
  angular:view
  angular:route
  angular:filter
  angular:controller
  angular:app

Testacular:
  testacular:app

Quickstart:
  quickstart:all

Bbb:
  bbb:all

Ember:
  ember:controller
  ember:all
  ember:view
  ember:model
  ember:app

Chromeapp:
  chromeapp:all

Ember-starter:
  ember-starter:all

Backbone:
  backbone:model
  backbone:view
  backbone:router
  backbone:collection
  backbone:app
  backbone:all
</code></pre>

<p>虽然目前我只用到了 Bbb 模板, 但还是得赞一下其模板的齐全.</p>

<!--more-->


<h2>前端 Javascript 包管理</h2>

<p>在目前, 我们都是手工增加和管理前端应用中用到的 Javascript 库, 例如说 jQuery, 每次当 jQuery 发布一个新版本, 我们都不得不手工地从官网上下载最新的发布文件, 然后将这个文件复制到自己的项目中.</p>

<p>Yemoman 可以让我们省掉这种麻烦的手工操作. 它集成了前端 Javascript 包管理应用 <a href="https://github.com/twitter/bower">Bower</a>, 我们只需要简单地运行 <code>yeoman install jquery</code>, 或者 <code>yeoman update jquery</code> 就能安装或者更新 jQuery 库文件.</p>

<h2>监测文件更新并自动重新加载应用</h2>

<p>每次当源文件有了修改, 无论是 HTML, CSS, Markdown 文件, 还是脚本文件, 或者其他需要预处理的 CoffeeScript, Sass 等文件, Yeoman 带来的活动加载监测进程会自动重新加载你的页面.
在调试的过程中, 这个功能的确能帮你省不少手工刷新的麻烦:-).</p>

<p>使用 <code>yeoman server</code> 就能运行一个本地 Web 服务器, 监测文件的变化并实时重新加载应用.</p>

<h2>强大的构建系统</h2>

<p>Yeoman 也是基于 <a href="http://gruntjs.com/" title="Grunt is a task-based command line build tool for JavaScript projects.">grunt</a>, 并且额外开发了一些高度定制的构建任务. 对我来说比较新鲜的构建任务是图片的优化, 使用 OptiPNG 和 JPEGTran 优化图片来减少图片的下载时间, 初步测试的结果是能减少大约 30% 图片大小, 这在以前的项目中还没尝试过.</p>

<hr />

<p>最后, 下面是使用 Yeoman 重构后的地址本应用的<a href="/examples/yeoman-contacts/dist/">演示</a>和<a href="https://github.com/xiaocong/xiaocong.github.com/tree/source/source/examples/yeoman-contacts">源码</a>.</p>
</div>
 </div>

  
  <div class="post"> <div class="post-header">
  
    <h1 class="post-title">
      <a href="/blog/2012/10/09/use-backbone-dot-layoutmanager-to-assemble-layouts-with-backbone-views/">在Backbone项目中使用backbone.layoutmanager来组织页面布局</a>
    </h1>
  
  








  


<time datetime="2012-10-09T19:20:00+08:00" pubdate data-updated="true">Oct 9<span>th</span>, 2012</time>
</div>

<div class="post-content"><p><a href="https://github.com/backbone-boilerplate/grunt-bbb" title="Backbone Boilerplate framework tool.">bbb</a> 的 <code>init</code> 命令生成的初始化模板工程中包含有 <a href="https://github.com/tbranyen/backbone.layoutmanager">backbone.layoutmanager</a> 插件, 该插件提供了一种页面的结构化组织方式, 将 <code>Backbone Views</code> 组装成页面布局 <code>Layout</code>.</p>

<p><a href="https://github.com/tbranyen/backbone.layoutmanager">backbone.layoutmanager</a> 主要的目的是提供一种规则来管理 <code>Backbone.View</code> 的渲染, 程序员只需要遵循这套规则, 就能简化页面渲染的实现.
<a href="https://github.com/tbranyen/backbone.layoutmanager">backbone.layoutmanager</a> 主页已经很详细地介绍了使用方法, 这里就不再赘述. 下面是个人感觉在学习使用过程中感觉应当注意的几点:</p>

<h2>完全受管理的 render</h2>

<p><code>Backbone.LayoutView</code> 仅仅是一个将 <code>manage</code> 属性设置成 <code>true</code> 的 <code>Backbone.View</code>.</p>

<figure class='code'><figcaption><span>backbone.layoutmanager V0.6.6</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">Backbone</span><span class="p">.</span><span class="nx">LayoutView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
</span><span class='line'>  <span class="nx">manage</span><span class="o">:</span> <span class="kc">true</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>只有当 <code>manage</code> 属性被设置为 <code>true</code>, <code>LayoutManager</code> 才会接管 <code>Backbone.View</code> 的渲染.</p>

<h2>数据和模板</h2>

<p>视图的渲染需要 <code>template</code> 和 <code>serialize</code> 属性, 分别对应HTML模板和数据模型. <code>LayoutManager</code> 缺省使用 <a href="http://underscorejs.org/">underscore</a> 的 <code>template</code> 函数进行页面的渲染.</p>

<h2>嵌套视图</h2>

<p>可以通过 <code>setView</code>, <code>setViews</code>, <code>insertView</code>, <code>insertViews</code> 等函数在<strong>视图</strong>中嵌套多个其他的<strong>子视图</strong>.</p>

<h2>BeforeRender 和 AfterRender</h2>

<p><code>render</code> 完全处在 <code>LayoutManager</code> 的管理下, 因此, 如果你想在每次视图渲染前后做一些特殊的处理, 必须定义 <code>beforeRender</code> 和 <code>afterRender</code> 函数.
由于 <code>LayoutManager</code> 内部会在渲染<strong>视图</strong>前移除所有附加模式的<strong>子视图</strong>, 因此, 通常在 <code>beforeRender</code> 函数中调用 <code>setView</code> 和 <code>insertView</code> 来增加和设置<strong>子视图</strong>.</p>

<p><em>如果你不想在每次渲染时移除子视图, 自己控制子视图的增删, 可以设置子视图的 <code>keep</code> 属性为 <code>true</code>.</em></p>

<h2>Cleanup 函数</h2>

<p>很多视图(View)都有数据模型(model)的事件绑定函数, 因此, 必须在视图被删除后解除绑定. 可以通过定义视图的 <code>cleanup</code> 函数来完成这个解绑操作:</p>

<figure class='code'><figcaption><span>cleanup函数</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">MyView</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
</span><span class='line'>  <span class="c1">// The constructor binds the model&#39;s &quot;change&quot; event to the view&#39;s render function. </span>
</span><span class='line'>  <span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;change&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span><span class="err">，</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// This is a custom cleanup method that will remove the model events owned by</span>
</span><span class='line'>  <span class="c1">// this View.</span>
</span><span class='line'>  <span class="nx">cleanup</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">off</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<h2>自定义获取模版</h2>

<p><code>LayoutManager</code> 缺省只支持 <code>script</code> 标签的模版, 但是在实际软件项目中, 通常会将不同的模版放置在不同的单独的 html 文件中, 这样便于模版文件的管理.
<code>LayoutManager</code> 提供了 <code>fetch</code> 配置项让我们有机会来自己获得模版文件:</p>

<figure class='code'><figcaption><span>从script标签中获得模版内容</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'>  <span class="nx">Backbone</span><span class="p">.</span><span class="nx">LayoutManager</span><span class="p">.</span><span class="nx">configure</span>
</span><span class='line'>    <span class="c1"># Default fetch implementation, get template from `script` tag</span>
</span><span class='line'>    <span class="nv">fetch: </span><span class="nf">(path)-&gt;</span>
</span><span class='line'>      <span class="nx">_</span><span class="p">.</span><span class="nx">template</span> <span class="nx">$</span><span class="p">(</span><span class="nx">path</span><span class="p">).</span><span class="nx">html</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>同步方式获取模版文件</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'>  <span class="nv">JST = </span><span class="nb">window</span><span class="p">.</span><span class="nv">JST = </span><span class="nb">window</span><span class="p">.</span><span class="nx">JST</span> <span class="o">or</span> <span class="p">{}</span>
</span><span class='line'>  <span class="nx">Backbone</span><span class="p">.</span><span class="nx">LayoutManager</span><span class="p">.</span><span class="nx">configure</span>
</span><span class='line'>    <span class="nv">manage: </span><span class="kc">true</span>
</span><span class='line'>    <span class="nv">paths:</span>
</span><span class='line'>      <span class="nv">layout: </span><span class="s2">&quot;templates/layouts/&quot;</span>
</span><span class='line'>      <span class="nv">template: </span><span class="s2">&quot;templates/&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">fetch: </span><span class="nf">(path) -&gt;</span>
</span><span class='line'>      <span class="nv">path = </span><span class="nx">path</span> <span class="o">+</span> <span class="s2">&quot;.html&quot;</span>
</span><span class='line'>      <span class="nx">unless</span> <span class="nx">JST</span><span class="p">[</span><span class="nx">path</span><span class="p">]</span>
</span><span class='line'>        <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">(</span>
</span><span class='line'>          <span class="nv">url: </span><span class="nx">app</span><span class="p">.</span><span class="nx">root</span> <span class="o">+</span> <span class="nx">path</span>
</span><span class='line'>          <span class="nv">async: </span><span class="kc">false</span>
</span><span class='line'>        <span class="p">).</span><span class="k">then</span> <span class="nf">(contents) -&gt;</span>
</span><span class='line'>          <span class="nx">JST</span><span class="p">[</span><span class="nx">path</span><span class="p">]</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">template</span><span class="p">(</span><span class="nx">contents</span><span class="p">)</span>
</span><span class='line'>      <span class="nx">JST</span><span class="p">[</span><span class="nx">path</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>下面是作者的教学视频, 初学者一定要看看.</p>

<iframe src="http://player.vimeo.com/video/32765088" width="500" height="313" frameborder="0" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe>


<p> <p><a href="http://vimeo.com/32765088">backbone.layoutmanager</a> from <a href="http://vimeo.com/user5699767">tbranyen</a> on <a href="http://vimeo.com">Vimeo</a>.</p></p>
</div>
 </div>

  
  <div class="post"> <div class="post-header">
  
    <h1 class="post-title">
      <a href="/blog/2012/08/09/what-you-should-know-for-spa-project/">开发SPA前端项目必须掌握什么知识?</a>
    </h1>
  
  








  


<time datetime="2012-08-09T21:46:00+08:00" pubdate data-updated="true">Aug 9<span>th</span>, 2012</time>
</div>

<div class="post-content"><p>这个题目有点大, 因为对于开发SPA(单页面应用, Single Page Application), 一个前端工程师需要掌握太多太多知识和工具了.
这里只说我自己最近半年在摸索和研究前端SPA相关技术的过程中的一些经验和总结.</p>

<h2>选择合适的开发IDE</h2>

<p>一个好的IDE可以让你敲键盘的次数大大减少, 我个人推荐使用<a href="http://www.sublimetext.com/">Sublime Text</a>, 速递快, 功能强大, 可扩充, 这也是我目前正在使用的IDE.</p>

<h2>选择合适的开发语言</h2>

<p>呃, 难道还有别的选择? 开发前端应用不都是用Javascript么? 对的, 因为现在有了<a href="http://coffeescript.org/">CoffeeScript</a>.
相比于Javascript的类C++/Java静态语言语法, CoffeeScript提供了更贴近自然语言的动态语言语法, 更少的代码, 更少的语法漏洞, 更好的代码可读性.</p>

<h2>选择合适的Javascript前端MVC框架</h2>

<p>Javascript程序很难调试, 特别是当代码行数超过一定量级之后.
为了让程序逻辑更有条例, 与服务器端的web框架类似, 前端也有很多Javascript库或者框架提供了MVC或类MVC架构.
按照MVC架构进行设计, 可以很清晰地将Module(数据模块), View(页面展示), Controller(用户行为响应控制)进行分离.
对于小型web应用来说, 这可能无关紧要, 甚至MVC带来的弊端会掩盖它的优点, 但对于一个超过上千行的web应用来说,
一个清晰的程序架构可以极大地减少模块间的耦合性.</p>

<p>大家可以仔细看一下<a href="http://codebrief.com/2012/01/the-top-10-javascript-mvc-frameworks-reviewed/">Top 10 Javascript MVC框架的对比</a>.
我个人感觉, <a href="http://documentcloud.github.com/backbone/">Backbone</a>的代码更紧凑一些, 开发社区也比较活跃.</p>

<h2>模块定义与加载管理</h2>

<p>Javascript语言自身不提供代码的加载管理, 当JavaScript代码分成多个模块, 处于不同文件中时,
如何管理模块之间的依赖关系以及文件的加载顺序, 就会变成一个非常棘手的事情. 并且JavaScript自身不提供名字空间的管理, 不同模块,
不同的JavaScript库之间的都有可能出现命名冲突.</p>

<p><a href="https://github.com/amdjs/amdjs-api/wiki/AMD">AMD(Asynchronous Module Definition)</a>是用来规范如何定义模块及其依赖项, 以及如何异步加载模块.
大家可以参考<a href="http://twitter.com/addyosmani">Addy Osmani</a>的博文<a href="http://addyosmani.com/writing-modular-js/">Writing Modular JavaScript With AMD, CommonJS &amp; ES Harmony</a>来了解具体的细节.</p>

<p>目前前端使用最广泛的前端AMD库应当是<a href="http://requirejs.org/">RequireJS</a>.</p>

<h2>代码质量静态检查</h2>

<p>Javascript代码的书写格式非常自由, 甚至带着错都能运行下去, 这也是为什么JavaScript代码很难调试的原因之一.</p>

<p>进行代码质量的静态检查可以极大减少由于语法漏洞或者拼写疏忽带来的这些额外错误, 推荐使用<a href="http://www.jshint.com/">jshint</a>.
如果使用CoffeeScript, 这步可以省略了, CoffeeScript编译后的代码都能通过jshint的检测.</p>

<!--more-->


<h2>单元测试</h2>

<p>单元测试是一个非常大的话题, 我没有办法用简短的一段话或者一篇文章将单元测试涉及到的方法和工具都介绍清楚.</p>

<p>技术大牛们都不愿意做单元测试, 当然, 很少有软件工程师愿意承认自己不是技术大牛:).
因为人员, 时间或者其他各种因素, 很多软件工程师们都愿意首先舍弃单元测试, 去保证功能的实现.</p>

<p>这里我不想挑起争论, 但我的经验的确是, 从个人角度上看, 单元测试能很大加深程序员对代码的理解程度, 加速个人能力的提升;
从项目角度上看, 技术经理需要权衡当前的开发, 回归测试和后继的代码维护成本之间的平衡, 然后决定是否实施单元测试,
以及多少程度的单元测试, 这是技术经理的职责.</p>

<p>在前端web应用中比较常用的单元测试框架包括：</p>

<ul>
<li><a href="http://pivotal.github.com/jasmine/">Jasmine</a></li>
<li><a href="http://docs.jquery.com/QUnit">QUnit</a></li>
<li><a href="http://visionmedia.github.com/mocha/">Mocha</a></li>
</ul>


<p>Mock库可以采用<a href="http://sinonjs.org/">SinonJS</a>. 如果愿意, 还可以采用<a href="http://github.com/visionmedia/should.js">Should</a>,
<a href="https://github.com/LearnBoost/expect.js">Expect</a>, <a href="http://chaijs.com/">Chai</a>等Assertion库.</p>

<p>另外, 如果希望在持续集成中加入对测试的支持, 还需要加入Non-GUI浏览器的支持, 目前采用比较多的方案是:</p>

<ul>
<li><a href="http://phantomjs.org/">PhantomJS</a></li>
<li><a href="http://zombie.labnotes.org/">Zombie</a></li>
</ul>


<p>由于<a href="http://zombie.labnotes.org/">Zombie</a>当前的版本还不能支持<a href="http://requirejs.org/">RequireJS</a>, 因此我更倾向于使用<a href="http://phantomjs.org/">PhantomJS</a>.</p>

<h2>Minification &amp; Concatenation</h2>

<p>为了提高web应用的加载速度, 必须对Javascript文件, CSS文件进行Minification和Concatenation, 根据经验, 优化后的代码加载速度比优化前的要提高数倍.</p>

<p>常用的工具包括:</p>

<ul>
<li><a href="http://developer.yahoo.com/yui/compressor/">YUI Compressor</a></li>
<li><a href="http://code.google.com/closure/compiler/">Google Closure Compiler</a></li>
<li><a href="https://github.com/mishoo/UglifyJS/">UglifyJS</a></li>
</ul>


<p>大部分开源的JavaScript构建工具都集成了对这些工具的支持, 因此没必要在这些工具上面花太多精力.
使用了<a href="http://requirejs.org/">RequireJS</a>的应用, 可以直接使用其自带的<a href="http://requirejs.org/docs/optimization.html">r.js</a>进行代码优化.</p>

<h2>构建和部署</h2>

<p>任何web应用工程都需要构建和部署, 一个自动化的构建和部署脚本能让编程人员更加专注于应用本身, 而不被繁琐的流程所困扰.
自动化的构建和部署是一个web前端项目最基本的要求, 当项目开始的时候, 项目组最好能在头两个迭代周期就完成自动化的构建和部署脚本的开发.</p>

<p>目前使用比较多的构建工具有:</p>

<ul>
<li><a href="https://github.com/moxiecode/js-build-tools">js-build-tools</a></li>
<li><a href="https://github.com/jcoglan/jake/">jake</a></li>
<li>CoffeeScript自带的<a href="http://coffeescript.org/#cake">cake</a></li>
<li>make</li>
<li><a href="https://github.com/cowboy/grunt">grunt</a></li>
</ul>


<p>我个人比较倾向于<a href="https://github.com/cowboy/grunt">grunt</a>, 如果工程中用了<a href="http://requirejs.org/">RequireJS</a>,
<a href="https://github.com/backbone-boilerplate/grunt-bbb">bbb</a>(grunt扩展)是更好的选择.</p>

<p>在<a href="https://github.com/xiaocong/xiaocong.github.com/tree/master/examples/coffee-bbb-amd-backbone-rest-contacts">网络地址本例子工程</a>中,
我使用<code>grunt/bbb</code>开发了构建和部署脚本, 可以完成:</p>

<ul>
<li>文件的复制和清除</li>
<li>CoffeeScript的编译</li>
<li>JSHint</li>
<li>Minification &amp; Concatenation</li>
<li>在Phantom环境下运行Jasmine单元测试</li>
<li>Debug/Release Web服务器</li>
</ul>


<p>感兴趣的人可以去看看上述例子工程的<a href="https://github.com/xiaocong/xiaocong.github.com/tree/master/examples/coffee-bbb-amd-backbone-rest-contacts/grunt.js">grunt.js</a>配置文件,
也可以将这个例子工程作为web前端项目的模板.</p>

<p><strong>下面的几点感触和具体的技术细节无关, 但是我个人觉得, 对于每个想以编程作为自己职业规划的程序员来说, 这几点尤其重要.</strong></p>

<h2>了解业界的技术发展动态</h2>

<p>软件技术发展很快, 对于热爱技术的程序员来说, 必须经常更新自己的知识, 才能保证自己不会落伍.
因此, 每天都需要花一定时间去阅读, 了解行业最新的技术发展动态.</p>

<p>我的习惯是用Google Reader订阅几个经常更新的前端技术相关的RSS:</p>

<ul>
<li><a href="http://addyosmani.com/blog/">Addy Osmani&#8217;s Blog</a></li>
<li><a href="http://dailyjs.com/">DailyJS</a></li>
<li><a href="http://www.mhtml5.com/">HTML5研究小组</a></li>
</ul>


<p>另外, 有些邮件周报也很不错:</p>

<ul>
<li><a href="http://javascriptweekly.com/">JavaScript Weekly</a></li>
<li><a href="http://html5weekly.com/">HTML5 Weekly</a></li>
</ul>


<h2>多阅读开源代码, 最好参与感兴趣的开源项目</h2>

<p><a href="http://github.com/">GitHub</a>是一个非常有用的站点, 在上面能看到那些大牛们是怎么讨论问题, 如何思考问题, 以及如何实现或者修正的.
阅读开源项目的文档能了解概要, 如果需要了解细节, 最有效的方式是阅读代码, 特别是看针对问题的提交记录.</p>

<h2>善于利用互联网工具</h2>

<h3>遇到问题的时候, 要知道如何去寻找问题的答案</h3>

<p><a href="http://stackoverflow.com/">StackOverflow</a>是一个非常有名的编程问答站点, 我所遇到的大部分编程问题都能在上面找到答案,
即便没有答案, 也能找到其他人对这个问题的考虑. 另外, 别忘了强大的<a href="http://www.google.com/">Google Search</a>. 如果Google被墙, 可以考虑用<a href="http://www.bing.com/">Bing</a>.
我不喜欢<a href="http://www.baidu.com/">百度</a>, 因为其搜索的命中率太低了.</p>

<h3>善于使用云端的工具</h3>

<p>选择合适的工具对于软件项目来说, 可以极大地提高工作效率, 起到事半功倍的效果. 好的商业软件大多需要支付巨额的费用, 并且搞不好还水土不服.
为了控制成本, 可以多尝试尝试云端的工具. 在<a href="http://www.zhihu.com/question/20114578">知乎</a>上有关于这些工具的讨论, 大家有兴趣可以去看看别人怎么做的.</p>

<h3>多参与技术社区活动, 学会分享</h3>

<p>多参加技术社区的活动, 包括线上的技术解答, 以及线下的技术讲座等. 分享越多, 获得也就越多.</p>
</div>
 </div>

  
  <div class="post"> <div class="post-header">
  
    <h1 class="post-title">
      <a href="/blog/2012/07/20/integrate-requirejs-slash-backbone-slash-jasmine-front-end-project-with-ci-using-bbb-slash-gruntjs/">Requirejs/Backbone/Jasmine前端项目和持续继承</a>
    </h1>
  
  








  


<time datetime="2012-07-20T11:03:00+08:00" pubdate data-updated="true">Jul 20<span>th</span>, 2012</time>
</div>

<div class="post-content"><p><a href="http://xiaocong.github.com/examples/coffee-bbb-amd-backbone-rest-contacts/dist/release/">Contact</a>(<a href="https://github.com/xiaocong/xiaocong.github.com/tree/master/examples/coffee-bbb-amd-backbone-rest-contacts">源代码</a>)示例项目使用了<a href="https://github.com/backbone-boilerplate/grunt-bbb" title="Backbone Boilerplate framework tool.">bbb</a>作为项目构建工具,
作为<a href="https://github.com/cowboy/grunt" title="task-based command line build tool for JavaScript projects">gruntjs</a>的扩展, <a href="https://github.com/backbone-boilerplate/grunt-bbb" title="Backbone Boilerplate framework tool.">bbb</a>能很方便地完成:</p>

<ul>
<li>Coffeescript的编译</li>
<li>文件的清除和复制</li>
<li>源代码lint</li>
<li>编译LESS</li>
<li>优化requirejs模块</li>
<li>js/css文件的合并和优化</li>
<li>文件的压缩, 打包</li>
<li>内置调试http服务器</li>
</ul>


<p>并且项目中还使用<a href="https://github.com/backbone-boilerplate/grunt-bbb" title="Backbone Boilerplate framework tool.">bbb</a>进行<a href="http://pivotal.github.com/jasmine/">jasmine</a>单元测试代码的编译. 所有的操作都可以通过定义<a href="https://github.com/backbone-boilerplate/grunt-bbb" title="Backbone Boilerplate framework tool.">bbb</a>任务并以命令行方式进行运行, 唯一的一个例外是<a href="http://pivotal.github.com/jasmine/">jasmine</a>测试执行需要启动浏览器执行.
如果要在项目中实施持续集成, 就必须不能依赖浏览器而以命令行方式执行测试.</p>

<p>曾经尝试过<a href="http://www.envjs.com/">envjs</a>, 但在当前的实现中, <a href="http://www.envjs.com/">envjs</a>还不能顺利运行<a href="http://requirejs.org/">requirejs</a>的异步模块加载(<a href="https://github.com/envjs/env-js/issues/7">issue</a>).
<a href="http://phantomjs.org/">Phantomjs</a>是另外一种方案, 它可以很顺利地集成<a href="http://pivotal.github.com/jasmine/">jasmine</a>以及<a href="http://requirejs.org/">requirejs</a>, 但是如果需要集成得很好, 必须得实现一个<a href="http://pivotal.github.com/jasmine/">jasmine</a>的<code>reporter</code>用来和<a href="http://phantomjs.org/">Phantomjs</a>进行通讯,
并且还得实现一个<a href="https://github.com/cowboy/grunt" title="task-based command line build tool for JavaScript projects">gruntjs</a>任务插件, 用来调用<a href="http://phantomjs.org/">Phantomjs</a>执行测试, 以及生成测试报告. 这个工作量不大, 我也曾经完成了一个最简单的<a href="https://github.com/cowboy/grunt" title="task-based command line build tool for JavaScript projects">gruntjs</a>任务来调用<a href="http://phantomjs.org/">Phantomjs</a>. 正在想着怎样进行重构的时候,
突然发现最新的<a href="https://github.com/backbone-boilerplate/grunt-bbb" title="Backbone Boilerplate framework tool.">bbb</a>已经悄然导入了<a href="https://github.com/creynders/grunt-jasmine-task">grunt-jasmine-task</a>, 一个利用<a href="http://phantomjs.org/">Phantomjs</a>执行<a href="http://pivotal.github.com/jasmine/">jasmine</a>测试的<a href="https://github.com/cowboy/grunt" title="task-based command line build tool for JavaScript projects">gruntjs</a>任务插件.</p>

<p>Ok, 那一切就简单了. 现在仅仅需要修改<code>grunt.js</code>配置文件来定义项目的<code>jasmine</code>任务. 当然, 之前必须安装<a href="http://phantomjs.org/">Phantomjs</a>(<a href="https://github.com/cowboy/grunt" title="task-based command line build tool for JavaScript projects">gruntjs</a>网站上有关于如何安装的<a href="https://github.com/cowboy/grunt/blob/master/docs/faq.md#why-does-grunt-complain-that-phantomjs-isnt-installed">faq</a>).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>  <span class="nx">grunt</span><span class="p">.</span><span class="nx">initConfig</span><span class="p">({</span>
</span><span class='line'>    <span class="c1">// jasmine task is to run specs using phantom, before running it, you must</span>
</span><span class='line'>    <span class="c1">// make sure you have installed phantom following instruction on</span>
</span><span class='line'>    <span class="c1">// https://github.com/cowboy/grunt/blob/master/docs/faq.md#why-does-grunt-complain-that-phantomjs-isnt-installed</span>
</span><span class='line'>    <span class="nx">jasmine</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">all</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">src</span><span class="o">:</span><span class="p">[</span><span class="s1">&#39;http://localhost:8000/tests/SpecRunner.html&#39;</span><span class="p">],</span>
</span><span class='line'>        <span class="nx">timeout</span><span class="o">:</span> <span class="mi">300000</span> <span class="c1">//in milliseconds</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>启动<code>http</code>服务:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>./node_modules/bbb/bin/bbb server
</span><span class='line'>Running <span class="s2">&quot;server&quot;</span> task
</span><span class='line'>Listening on http://127.0.0.1:8000
</span></code></pre></td></tr></table></div></figure>


<p>然后在另一个终端运行<code>jasmine</code>任务:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>./node_modules/bbb/bin/bbb jasmine
</span><span class='line'>Running <span class="s2">&quot;jasmine:all&quot;</span> <span class="o">(</span>jasmine<span class="o">)</span> task
</span><span class='line'>Running specs <span class="k">for </span>SpecRunner.html
</span><span class='line'>.............
</span><span class='line'>&gt;&gt; 31 assertions passed in 13 specs <span class="o">(</span>1451ms<span class="o">)</span>
</span><span class='line'>
</span><span class='line'>Done, without errors.
</span></code></pre></td></tr></table></div></figure>




<!--more-->


<p>在CI系统中, 一种可行的做法是使用<code>shell</code>脚本或者<code>Makefile</code>, 先启动<code>http</code>服务, 然后异步执行测试. 这是一个可行的方案, 但是<code>grunt.js</code>本身就是一个命令行工具, 为什么还要用<code>shell</code>或者<code>make</code>了?</p>

<p><code>grunt.js</code>支持<code>alias task</code>, 我们可以这样定义一个任务别名:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">grunt</span><span class="p">.</span><span class="nx">registerTask</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="s1">&#39;default server jasmine&#39;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>执行<code>test</code>任务等价于按照顺序执行<code>default</code>, <code>server</code>, <code>jasmine</code>任务. 我们希望这样能工作, 可惜的是, <code>bbb</code>的<code>server</code>任务是阻塞式的, 不会退出,
也就是说, 在它后面的<code>jasmine</code>任务永远不会被执行.</p>

<p>我们希望执行一个<code>server</code>任务, 它能异步启动一个非阻塞的<code>http</code>服务, 后面的任务可以使用这个服务, 并且当<code>grunt</code>进程退出的时候, 该<code>http</code>服务能自动退出.
下面代码是用<code>node</code>的<code>connect</code>实现的满足这个要求的<code>staticserver</code>任务:</p>

<figure class='code'><figcaption><span>staticserver.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> * grunt</span>
</span><span class='line'><span class="cm"> * https://github.com/cowboy/grunt</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> * Copyright (c) 2012 &quot;Cowboy&quot; Ben Alman</span>
</span><span class='line'><span class="cm"> * Licensed under the MIT license.</span>
</span><span class='line'><span class="cm"> * http://benalman.com/about/license/</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'>
</span><span class='line'><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">grunt</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Nodejs libs.</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// External libs.</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">connect</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;connect&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// ==========================================================================</span>
</span><span class='line'>  <span class="c1">// TASKS</span>
</span><span class='line'>  <span class="c1">// ==========================================================================</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">grunt</span><span class="p">.</span><span class="nx">registerTask</span><span class="p">(</span><span class="s1">&#39;staticserver&#39;</span><span class="p">,</span> <span class="s1">&#39;Start a static web server.&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// Get values from config, or use defaults.</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">port</span> <span class="o">=</span> <span class="nx">grunt</span><span class="p">.</span><span class="nx">config</span><span class="p">(</span><span class="s1">&#39;server.port&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="mi">8000</span><span class="p">;</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">base</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">grunt</span><span class="p">.</span><span class="nx">config</span><span class="p">(</span><span class="s1">&#39;server.base&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="s1">&#39;.&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">middleware</span> <span class="o">=</span> <span class="p">[</span>
</span><span class='line'>      <span class="c1">// Serve static files.</span>
</span><span class='line'>      <span class="nx">connect</span><span class="p">.</span><span class="kr">static</span><span class="p">(</span><span class="nx">base</span><span class="p">),</span>
</span><span class='line'>      <span class="c1">// Make empty directories browsable. (overkill?)</span>
</span><span class='line'>      <span class="nx">connect</span><span class="p">.</span><span class="nx">directory</span><span class="p">(</span><span class="nx">base</span><span class="p">)</span>
</span><span class='line'>    <span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// If --debug was specified, enable logging.</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">grunt</span><span class="p">.</span><span class="nx">option</span><span class="p">(</span><span class="s1">&#39;debug&#39;</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">connect</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="s1">&#39;grunt&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;[D] server :method :url :status &#39;</span> <span class="o">+</span>
</span><span class='line'>        <span class="s1">&#39;:res[content-length] - :response-time ms&#39;</span><span class="p">).</span><span class="nx">magenta</span><span class="p">);</span>
</span><span class='line'>      <span class="nx">middleware</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="nx">connect</span><span class="p">.</span><span class="nx">logger</span><span class="p">(</span><span class="s1">&#39;grunt&#39;</span><span class="p">));</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Start server.</span>
</span><span class='line'>    <span class="nx">grunt</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">writeln</span><span class="p">(</span><span class="s1">&#39;Starting static web server on port &#39;</span> <span class="o">+</span> <span class="nx">port</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">connect</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">middleware</span><span class="p">).</span><span class="nx">listen</span><span class="p">(</span><span class="nx">port</span><span class="p">);</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>假如你看过<a href="https://github.com/cowboy/grunt" title="task-based command line build tool for JavaScript projects">gruntjs</a>的代码, 你应当能看出来, 这其实就是<a href="https://github.com/cowboy/grunt" title="task-based command line build tool for JavaScript projects">gruntjs</a>自带的<code>server</code>任务, 只是为了避免和<code>bbb</code>的<code>server</code>任务命名冲突, 这里将任务注册的名称从<code>server</code>换成了<code>staticserver</code>.</p>

<p>将<code>staticserver.js</code>文件和其他<code>gruntjs</code> <code>task</code>文件一样存放在<code>&lt;工程目录&gt;/tasks</code>目录下, 确保这个任务能正确加载. 然后, 如下注册一个<code>alias task</code>命名为<code>test</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>  <span class="c1">// Register test task, which will compile app and run the server and then do test.</span>
</span><span class='line'>  <span class="c1">// Here we use &#39;staticserver&#39; task (pure grunt static server) for testing.</span>
</span><span class='line'>  <span class="nx">grunt</span><span class="p">.</span><span class="nx">registerTask</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="s1">&#39;default staticserver jasmine&#39;</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>运行这个<code>test</code>任务就能到下面的输出:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">$</span> <span class="p">.</span><span class="o">/</span><span class="nx">node_modules</span><span class="o">/</span><span class="nx">bbb</span><span class="o">/</span><span class="nx">bin</span><span class="o">/</span><span class="nx">bbb</span> <span class="nx">test</span>
</span><span class='line'><span class="nx">Running</span> <span class="s2">&quot;clean:0&quot;</span> <span class="p">(</span><span class="nx">clean</span><span class="p">)</span> <span class="nx">task</span>
</span><span class='line'><span class="nx">Removing</span><span class="o">:</span> <span class="nx">app</span>
</span><span class='line'><span class="nx">Removing</span><span class="o">:</span> <span class="nx">dist</span><span class="o">/</span><span class="nx">debug</span>
</span><span class='line'><span class="nx">Removing</span><span class="o">:</span> <span class="nx">dist</span><span class="o">/</span><span class="nx">release</span>
</span><span class='line'><span class="nx">Removing</span><span class="o">:</span> <span class="nx">tests</span><span class="o">/</span><span class="nx">js</span>
</span><span class='line'>
</span><span class='line'><span class="nx">Running</span> <span class="s2">&quot;clean:1&quot;</span> <span class="p">(</span><span class="nx">clean</span><span class="p">)</span> <span class="nx">task</span>
</span><span class='line'><span class="nx">Removing</span><span class="o">:</span> <span class="nx">app</span>
</span><span class='line'><span class="nx">Removing</span><span class="o">:</span> <span class="nx">dist</span><span class="o">/</span><span class="nx">debug</span>
</span><span class='line'><span class="nx">Removing</span><span class="o">:</span> <span class="nx">dist</span><span class="o">/</span><span class="nx">release</span>
</span><span class='line'><span class="nx">Removing</span><span class="o">:</span> <span class="nx">tests</span><span class="o">/</span><span class="nx">js</span>
</span><span class='line'>
</span><span class='line'><span class="nx">Running</span> <span class="s2">&quot;clean:2&quot;</span> <span class="p">(</span><span class="nx">clean</span><span class="p">)</span> <span class="nx">task</span>
</span><span class='line'><span class="nx">Removing</span><span class="o">:</span> <span class="nx">app</span>
</span><span class='line'><span class="nx">Removing</span><span class="o">:</span> <span class="nx">dist</span><span class="o">/</span><span class="nx">debug</span>
</span><span class='line'><span class="nx">Removing</span><span class="o">:</span> <span class="nx">dist</span><span class="o">/</span><span class="nx">release</span>
</span><span class='line'><span class="nx">Removing</span><span class="o">:</span> <span class="nx">tests</span><span class="o">/</span><span class="nx">js</span>
</span><span class='line'>
</span><span class='line'><span class="nx">Running</span> <span class="s2">&quot;clean:3&quot;</span> <span class="p">(</span><span class="nx">clean</span><span class="p">)</span> <span class="nx">task</span>
</span><span class='line'><span class="nx">Removing</span><span class="o">:</span> <span class="nx">app</span>
</span><span class='line'><span class="nx">Removing</span><span class="o">:</span> <span class="nx">dist</span><span class="o">/</span><span class="nx">debug</span>
</span><span class='line'><span class="nx">Removing</span><span class="o">:</span> <span class="nx">dist</span><span class="o">/</span><span class="nx">release</span>
</span><span class='line'><span class="nx">Removing</span><span class="o">:</span> <span class="nx">tests</span><span class="o">/</span><span class="nx">js</span>
</span><span class='line'>
</span><span class='line'><span class="nx">Running</span> <span class="s2">&quot;coffee:app&quot;</span> <span class="p">(</span><span class="nx">coffee</span><span class="p">)</span> <span class="nx">task</span>
</span><span class='line'>
</span><span class='line'><span class="nx">Running</span> <span class="s2">&quot;lint:beforeconcat&quot;</span> <span class="p">(</span><span class="nx">lint</span><span class="p">)</span> <span class="nx">task</span>
</span><span class='line'><span class="nx">Lint</span> <span class="nx">free</span><span class="p">.</span>
</span><span class='line'>
</span><span class='line'><span class="nx">Running</span> <span class="s2">&quot;coffee:spec&quot;</span> <span class="p">(</span><span class="nx">coffee</span><span class="p">)</span> <span class="nx">task</span>
</span><span class='line'>
</span><span class='line'><span class="nx">Running</span> <span class="s2">&quot;staticserver&quot;</span> <span class="nx">task</span>
</span><span class='line'><span class="nx">Starting</span> <span class="kr">static</span> <span class="nx">web</span> <span class="nx">server</span> <span class="nx">on</span> <span class="nx">port</span> <span class="mi">8000</span><span class="p">.</span>
</span><span class='line'>
</span><span class='line'><span class="nx">Running</span> <span class="s2">&quot;jasmine:all&quot;</span> <span class="p">(</span><span class="nx">jasmine</span><span class="p">)</span> <span class="nx">task</span>
</span><span class='line'><span class="nx">Running</span> <span class="nx">specs</span> <span class="k">for</span> <span class="nx">SpecRunner</span><span class="p">.</span><span class="nx">html</span>
</span><span class='line'><span class="p">.............</span>
</span><span class='line'><span class="o">&gt;&gt;</span> <span class="mi">31</span> <span class="nx">assertions</span> <span class="nx">passed</span> <span class="k">in</span> <span class="mi">13</span> <span class="nx">specs</span> <span class="p">(</span><span class="mi">2256</span><span class="nx">ms</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nx">Done</span><span class="p">,</span> <span class="nx">without</span> <span class="nx">errors</span><span class="p">.</span>
</span></code></pre></td></tr></table></div></figure>


<h2>参考</h2>

<ul>
<li><a href="https://github.com/xiaocong/xiaocong.github.com/tree/master/examples/coffee-bbb-amd-backbone-rest-contacts">示例程序源代码</a></li>
<li><a href="https://github.com/backbone-boilerplate/grunt-bbb" title="Backbone Boilerplate framework tool.">bbb</a></li>
<li><a href="https://github.com/cowboy/grunt" title="task-based command line build tool for JavaScript projects">gruntjs</a></li>
<li><a href="http://phantomjs.org/">Phantomjs</a></li>
</ul>

</div>
 </div>

  
  <div class="post"> <div class="post-header">
  
    <h1 class="post-title">
      <a href="/blog/2012/07/06/testing-backbone-and-requirejs-with-jasmine/">使用jasmine+sinon测试backbone+requirejs项目</a>
    </h1>
  
  








  


<time datetime="2012-07-06T00:32:00+08:00" pubdate data-updated="true">Jul 6<span>th</span>, 2012</time>
</div>

<div class="post-content"><p>我们必须为自己的代码写自动测试代码, 并且需要持续地对自己的代码进行回归测试, 因为:</p>

<ul>
<li>项目成员对模块间接口的理解必须一致, 测试代码是最好的文档.</li>
<li>谁都没十足的把握保证自己的修改不影响别人的代码.</li>
<li>没有快速而充分的测试作为保障, 就很难提倡快速重构.</li>
<li>让代码成为资产, 而不是债务, 减少代码的维护成本.</li>
<li>每个人都必须为自己的代码负责.</li>
</ul>


<p>那么基于<a href="http://backbonejs.com/" title="Backbone.js">backbone</a>+<a href="http://requirejs.org/" title="Require.js">requirejs</a>的前端项目应当如何实施测试?</p>

<p>当前已经有很多非常优秀的javascript测试框架, 包括<a href="http://pivotal.github.com/jasmine/">jasmine</a>,
<a href="http://docs.jquery.com/QUnit">QUnit</a>, <a href="http://visionmedia.github.com/mocha/">mocha</a>.
<a href="http://backbonejs.com/" title="Backbone.js">backbone</a>和<a href="http://requirejs.org/" title="Require.js">requirejs</a>的前端项目可以使用上述任何一种测试框架. 技术经理可以根据团队成员的技术背景, 喜好来决定选择哪一种测试框架.</p>

<p>下面就以<a href="/examples/coffee-bbb-amd-backbone-rest-contacts/index.html">Contacts</a>应用为例,
简单demo如何在项目中实现基于<a href="http://pivotal.github.com/jasmine/">jasmine</a>+<a href="http://sinonjs.org/" title="sinon.js">sinon</a>的测试用例.</p>

<ul>
<li><a href="https://github.com/xiaocong/xiaocong.github.com/tree/master/examples/coffee-bbb-amd-backbone-rest-contacts">源码</a></li>
<li><a href="/examples/coffee-bbb-amd-backbone-rest-contacts/tests/SpecRunner.html">测试执行demo</a></li>
</ul>


<h2>工程的目录结构</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>|-coffee                <span class="c"># web应用coffeescript源代码</span>
</span><span class='line'>|-app                   <span class="c"># coffee编译之后的web应用js文件</span>
</span><span class='line'>|-dist
</span><span class='line'>   |-debug              <span class="c"># concat所有js文件到一个js文件, 但未作minize</span>
</span><span class='line'>   |-release            <span class="c"># concat所有js文件到一个js文件, 并且minize</span>
</span><span class='line'>|-assets                <span class="c"># jquery/requirejs/underscore/backbone等库文件</span>
</span><span class='line'>|-tests
</span><span class='line'>   |-coffee             <span class="c"># 测试程序的coffeescript源代码</span>
</span><span class='line'>      |-config.coffee   <span class="c"># requirejs配置文件</span>
</span><span class='line'>      |-runner.coffee   <span class="c"># 按照requirejs模块定义规范定义的jasmine测试执行模块</span>
</span><span class='line'>   |-js                 <span class="c"># coffee编译之后的测试程序js文件</span>
</span><span class='line'>   |-lib                <span class="c"># jasmine/sinon等测试用库文件</span>
</span><span class='line'>   |-SpecRunner.html    <span class="c"># 测试html文件, 用来执行broqser端测试代码</span>
</span><span class='line'>|-index.html            <span class="c"># app html文件</span>
</span><span class='line'>|-favicon.ico
</span><span class='line'>|-grunt.js              <span class="c"># grunt任务配置文件</span>
</span></code></pre></td></tr></table></div></figure>


<h2>按照<a href="http://requirejs.org/" title="Require.js">requirejs</a>的模块定义方式定义<em>测试模块</em></h2>

<p>由于<em>被测模块</em>是由<a href="http://requirejs.org/" title="Require.js">requirejs</a>进行加载的, 因此, 我们也可以遵循<a href="http://requirejs.org/" title="Require.js">requirejs</a>的模块定义方式定义<em>测试模块</em>, 确保<em>被测模块</em>在<em>测试模块</em>前加载完成:</p>

<figure class='code'><figcaption><span>model_spec.coffee</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="nx">define</span> <span class="p">[</span><span class="nx">use</span><span class="o">!</span><span class="nx">underscore</span><span class="s1">&#39;, &#39;</span><span class="nx">use</span><span class="o">!</span><span class="nx">backbone</span><span class="s1">&#39;, &#39;</span><span class="nx">model</span><span class="err">/under/test&#39;], (_, Backbone, model) -&gt;</span>
</span><span class='line'>  <span class="nx">describe</span> <span class="s2">&quot;suite description...&quot;</span><span class="p">,</span> <span class="o">-&gt;</span>
</span><span class='line'>    <span class="nx">it</span> <span class="s2">&quot;spec description...&quot;</span><span class="p">,</span> <span class="o">-&gt;</span>
</span><span class='line'>      <span class="c1"># test code here ...</span>
</span></code></pre></td></tr></table></div></figure>


<p>下面是测试用例的代码(<code>collection</code>, <code>model</code>, <code>view</code>各实现了一个模块的测试, 仅供demo):</p>

<ul>
<li><a href="/examples/coffee-bbb-amd-backbone-rest-contacts/tests/coffee/spec/collections/contacts.coffee">Collection测试Dmeo</a></li>
<li><a href="/examples/coffee-bbb-amd-backbone-rest-contacts/tests/coffee/spec/models/contact.coffee">Model测试Demo</a></li>
<li><a href="/examples/coffee-bbb-amd-backbone-rest-contacts/tests/coffee/spec/views/contactitem.coffee">View测试Demo</a></li>
</ul>


<!--more-->


<h2>加载<em>测试模块</em>, 定义测试<code>runner</code></h2>

<p>通过定义模块依赖, 确保在执行<code>runner</code>方法前加载所有的<em>测试模块</em>.</p>

<figure class='code'><figcaption><span>SpecRunner  (runner.coffee)</span> <a href='/examples/coffee-bbb-amd-backbone-rest-contacts/tests/coffee/runner.coffee'>download</a></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="c1"># we should add all specs here to make sure all specs are loaded before execution.</span>
</span><span class='line'><span class="nx">define</span> <span class="p">[</span><span class="s2">&quot;spec/models/contact&quot;</span>
</span><span class='line'>        <span class="s2">&quot;spec/collections/contacts&quot;</span>
</span><span class='line'>        <span class="s2">&quot;spec/views/contactitem&quot;</span><span class="p">],</span> <span class="o">-&gt;</span>
</span><span class='line'>  <span class="nv">runner = </span><span class="o">-&gt;</span>
</span><span class='line'>    <span class="nv">jasmineEnv = </span><span class="nx">jasmine</span><span class="p">.</span><span class="nx">getEnv</span><span class="p">()</span>
</span><span class='line'>    <span class="nv">jasmineEnv.updateInterval = </span><span class="mi">1000</span>
</span><span class='line'>    <span class="nv">trivialReporter = </span><span class="k">new</span> <span class="nx">jasmine</span><span class="p">.</span><span class="nx">TrivialReporter</span><span class="p">()</span>
</span><span class='line'>    <span class="nx">jasmineEnv</span><span class="p">.</span><span class="nx">addReporter</span> <span class="nx">trivialReporter</span>
</span><span class='line'>    <span class="nv">jasmineEnv.specFilter = </span><span class="nf">(spec) -&gt;</span>
</span><span class='line'>      <span class="nx">trivialReporter</span><span class="p">.</span><span class="nx">specFilter</span> <span class="nx">spec</span>
</span><span class='line'>    <span class="nx">jasmineEnv</span><span class="p">.</span><span class="nx">execute</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<h2>定义<a href="http://requirejs.org/" title="Require.js">requirejs</a>的配置文件, 执行测试<code>runner</code></h2>

<p>由于我们希望通过一个配置文件同时加载<em>被测模块</em>和<em>测试模块</em>, 因此这里<code>require.config</code>的<code>baseUrl</code>项必须与web应用的该值保持一致.</p>

<figure class='code'><figcaption><span>require.config  (config.coffee)</span> <a href='/examples/coffee-bbb-amd-backbone-rest-contacts/tests/coffee/config.coffee'>download</a></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="nx">require</span><span class="p">.</span><span class="nx">config</span>
</span><span class='line'>  <span class="nv">baseUrl: </span><span class="s2">&quot;../app&quot;</span>
</span><span class='line'>  <span class="nv">paths:</span>
</span><span class='line'>    <span class="nv">libs: </span><span class="s2">&quot;../assets/js&quot;</span>
</span><span class='line'>    <span class="nv">jquery: </span><span class="s1">&#39;../assets/js/jquery/1.7.2/jquery&#39;</span>
</span><span class='line'>    <span class="nv">underscore: </span><span class="s1">&#39;../assets/js/underscore/1.3.2/underscore&#39;</span>
</span><span class='line'>    <span class="nv">backbone: </span><span class="s1">&#39;../assets/js/backbone/0.9.2/backbone&#39;</span>
</span><span class='line'>    <span class="nv">text: </span><span class="s1">&#39;../assets/js/require/plugins/text&#39;</span>
</span><span class='line'>    <span class="nv">templates: </span><span class="s1">&#39;../assets/templates&#39;</span>
</span><span class='line'>    <span class="nv">spec: </span><span class="s2">&quot;../tests/js/spec&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">shim:</span>
</span><span class='line'>    <span class="s1">&#39;backbone&#39;</span><span class="o">:</span>
</span><span class='line'>      <span class="nv">deps: </span><span class="p">[</span><span class="s1">&#39;underscore&#39;</span><span class="p">,</span> <span class="s1">&#39;jquery&#39;</span><span class="p">],</span>
</span><span class='line'>      <span class="nv">exports: </span><span class="s1">&#39;Backbone&#39;</span>
</span><span class='line'>
</span><span class='line'>    <span class="s1">&#39;underscore&#39;</span><span class="o">:</span>
</span><span class='line'>      <span class="nv">exports: </span><span class="s1">&#39;_&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="nx">require</span> <span class="p">[</span><span class="s2">&quot;../tests/js/runner&quot;</span><span class="p">],</span> <span class="nf">(runner) -&gt;</span>
</span><span class='line'>  <span class="nx">runner</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<h2>定义<code>SpecRunner.html</code>, 用来在浏览器端执行策测试代码</h2>

<figure class='code'><figcaption><span>SpecRunner.html  (SpecRunner.html)</span> <a href='/examples/coffee-bbb-amd-backbone-rest-contacts/tests/SpecRunner.html'>download</a></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="o">&lt;!</span><span class="nx">DOCTYPE</span> <span class="nx">HTML</span> <span class="nx">PUBLIC</span> <span class="s2">&quot;-//W3C//DTD HTML 4.01 Transitional//EN&quot;</span>
</span><span class='line'>  <span class="s2">&quot;http://www.w3.org/TR/html4/loose.dtd&quot;</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="nx">html</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="nx">head</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">title</span><span class="o">&gt;</span><span class="nx">Jasmine</span> <span class="nx">Spec</span> <span class="nx">Runner</span><span class="o">&lt;</span><span class="err">/title&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">link</span> <span class="nx">rel</span><span class="o">=</span><span class="s2">&quot;stylesheet&quot;</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&quot;text/css&quot;</span> <span class="nx">href</span><span class="o">=</span><span class="s2">&quot;lib/jasmine.css&quot;</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">script</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&quot;text/javascript&quot;</span> <span class="nx">src</span><span class="o">=</span><span class="s2">&quot;lib/jasmine.js&quot;</span><span class="o">&gt;&lt;</span><span class="err">/script&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">script</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&quot;text/javascript&quot;</span> <span class="nx">src</span><span class="o">=</span><span class="s2">&quot;lib/jasmine-html.js&quot;</span><span class="o">&gt;&lt;</span><span class="err">/script&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">script</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&quot;text/javascript&quot;</span> <span class="nx">src</span><span class="o">=</span><span class="s2">&quot;lib/sinon.js&quot;</span><span class="o">&gt;&lt;</span><span class="err">/script&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">script</span> <span class="nx">data</span><span class="o">-</span><span class="nx">main</span><span class="o">=</span><span class="s2">&quot;js/config&quot;</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&quot;text/javascript&quot;</span> <span class="nx">src</span><span class="o">=</span><span class="s2">&quot;../assets/js/require/require.js&quot;</span><span class="o">&gt;&lt;</span><span class="err">/script&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="err">/head&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">body</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="err">/body&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="err">/html&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>下面是<a href="/examples/coffee-bbb-amd-backbone-rest-contacts/tests/SpecRunner.html">测试执行</a>的结果:</p>

<iframe src="/examples/coffee-bbb-amd-backbone-rest-contacts/tests/SpecRunner.html" width="100%" scrolling="no"></iframe>


<h2>遗留问题</h2>

<ul>
<li>由于<em>被测模块</em>的加载是由<a href="http://requirejs.org/" title="Require.js">requirejs</a>完成的, 那么如何在加载时mock<em>被测模块</em>的依赖模块?</li>
<li>如何和CI系统集成, 提供命令行方式的浏览器环境进行测试? 尝试过<a href="http://www.envjs.com/">envjs</a>, 但<a href="http://requirejs.org/" title="Require.js">requirejs</a>总在加载模块时出错, 还没能进一步研究出错细节.</li>
</ul>

</div>
 </div>

  
  <div class="post"> <div class="post-header">
  
    <h1 class="post-title">
      <a href="/blog/2012/06/26/backbone-dot-sync-and-crud/">Backbone.sync和资源的CRUD</a>
    </h1>
  
  








  


<time datetime="2012-06-26T01:33:00+08:00" pubdate data-updated="true">Jun 26<span>th</span>, 2012</time>
</div>

<div class="post-content"><blockquote><p>Backbone.sync是Backbone用来和服务器进行数据交换的方法. 每当Collection或者Model的数据发生变化, Backbone就会调用Backbone.sync进行数据的CRUD操作, 这个同步方法的缺省实现是使用(jQuery/Zepto).ajax向服务器发送RESTful JSON请求, 并返回一个jqXHR. 你可以通过重载这个方法来定义不同的持续化策略, 例如WebSocket, XML, 或者本地存储.</p><footer><strong>Backbone</strong> <cite><a href='http://documentcloud.github.com/backbone/#Sync'>Backbone.sync</a></cite></footer></blockquote>


<p>Backbone.sync的函数定义是<code>function(method, model, [options])</code>:</p>

<ul>
<li><strong>medhod</strong>: CRUD名称, 可以是<code>create</code>, <code>read</code>, <code>update</code>, <code>delete</code>.</li>
<li><strong>model</strong>: 需要保存的model, 可以是Backbone.Model或者Backbone.Collection.</li>
<li><strong>options</strong>: 所有jQuery请求选项, 包括success和error回掉函数.</li>
</ul>


<p>Backbone.sync方法的缺省实现是通过标准的RESTful风格的CRUD进行数据的操作. CRUD方法对应的REST接口分别是:</p>

<ul>
<li><strong>create</strong> -> <strong>POST</strong> <code>/collection</code></li>
<li><strong>read</strong> -> <strong>GET</strong> <code>/collection[/id]</code></li>
<li><strong>update</strong> -> <strong>PUT</strong> <code>/collection/id</code></li>
<li><strong>create</strong> -> <strong>DELETE</strong> <code>/collection/id</code></li>
</ul>


<p>你可以通过重载全局的Backbone.sync, 或者Collection/Model的sync方法来改变其缺省实现.</p>

<h2>localStorage方式实现Backbone.sync</h2>

<p>在<a href="http://xiaocong.github.com/examples/coffee-bbb-amd-backbone-contacts/index.html">地址本示例</a>中, 通过重载全局的Backbone.sync方法,
将Collection/Model的CRUD操作转化为localStorage的对象CRUD操作.</p>

<p>下面是Backbone.sync方法的定义(<a href="http://xiaocong.github.com/examples/coffee-bbb-amd-backbone-contacts/coffee/store.coffee">源码</a>),
首先获得传递进来的model对象或其集合对象的localStorage属性对象, 并将CRUD操作转化为localStorage属性对象的数据CRUD操作:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'>  <span class="nv">Backbone.sync = </span><span class="nf">(method, model, options) -&gt;</span>
</span><span class='line'>    <span class="nv">store = </span><span class="nx">model</span><span class="p">.</span><span class="nx">localStorage</span> <span class="o">or</span> <span class="nx">model</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">localStorage</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">switch</span> <span class="nx">method</span>
</span><span class='line'>      <span class="k">when</span> <span class="s2">&quot;read&quot;</span>
</span><span class='line'>        <span class="nv">resp = </span><span class="k">if</span> <span class="nx">model</span><span class="p">.</span><span class="nx">id</span> <span class="k">then</span> <span class="nx">store</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">model</span><span class="p">)</span> <span class="k">else</span> <span class="nx">store</span><span class="p">.</span><span class="nx">findAll</span><span class="p">()</span>
</span><span class='line'>      <span class="k">when</span> <span class="s2">&quot;create&quot;</span>
</span><span class='line'>        <span class="nv">resp = </span><span class="nx">store</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">model</span><span class="p">)</span>
</span><span class='line'>      <span class="k">when</span> <span class="s2">&quot;update&quot;</span>
</span><span class='line'>        <span class="nv">resp = </span><span class="nx">store</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">model</span><span class="p">)</span>
</span><span class='line'>      <span class="k">when</span> <span class="s2">&quot;delete&quot;</span>
</span><span class='line'>        <span class="nv">resp = </span><span class="nx">store</span><span class="p">.</span><span class="nx">destroy</span><span class="p">(</span><span class="nx">model</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="nx">resp</span>
</span><span class='line'>      <span class="nx">options</span><span class="p">.</span><span class="nx">success</span> <span class="nx">resp</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="nx">options</span><span class="p">.</span><span class="nx">error</span> <span class="s2">&quot;Record not found&quot;</span>
</span></code></pre></td></tr></table></div></figure>




<!--more-->


<p>localStorage属性对象的类型定义如下, 数据最后是通过HTML本地存储方法<code>localStorage.setItem</code>进行持久化存储:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'>  <span class="k">class</span> <span class="nx">Store</span>
</span><span class='line'>    <span class="nv">constructor: </span><span class="nf">(@name) -&gt;</span>
</span><span class='line'>      <span class="nv">store = </span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span><span class="nx">@name</span><span class="p">)</span>
</span><span class='line'>      <span class="vi">@data = </span><span class="p">(</span><span class="nx">store</span> <span class="o">and</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">store</span><span class="p">))</span> <span class="o">or</span> <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">save: </span><span class="o">-&gt;</span>
</span><span class='line'>      <span class="nx">localStorage</span><span class="p">.</span><span class="nx">setItem</span> <span class="nx">@name</span><span class="p">,</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">@data</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">create: </span><span class="nf">(model) -&gt;</span>
</span><span class='line'>      <span class="nv">model.id = model.attributes.id = </span><span class="nx">guid</span><span class="p">()</span> <span class="nx">unless</span> <span class="nx">model</span><span class="p">.</span><span class="nx">id</span>
</span><span class='line'>      <span class="nx">@data</span><span class="p">[</span><span class="nx">model</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">model</span>
</span><span class='line'>      <span class="nx">@save</span><span class="p">()</span>
</span><span class='line'>      <span class="nx">model</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">update: </span><span class="nf">(model) -&gt;</span>
</span><span class='line'>      <span class="nx">@data</span><span class="p">[</span><span class="nx">model</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">model</span>
</span><span class='line'>      <span class="nx">@save</span><span class="p">()</span>
</span><span class='line'>      <span class="nx">model</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">find: </span><span class="nf">(model) -&gt;</span>
</span><span class='line'>      <span class="nx">@data</span><span class="p">[</span><span class="nx">model</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">findAll: </span><span class="o">-&gt;</span>
</span><span class='line'>      <span class="nx">_</span><span class="p">.</span><span class="nx">values</span> <span class="nx">@data</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">destroy: </span><span class="nf">(model) -&gt;</span>
</span><span class='line'>      <span class="k">delete</span> <span class="nx">@data</span><span class="p">[</span><span class="nx">model</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span>
</span><span class='line'>      <span class="nx">@save</span><span class="p">()</span>
</span><span class='line'>      <span class="nx">model</span>
</span></code></pre></td></tr></table></div></figure>


<p>在定义Collection对象的时候, 需要定义其localStorage属性为上面定义的<code>Store</code>类型:</p>

<figure class='code'><figcaption><span> (contacts.coffee)</span> <a href='/examples/coffee-bbb-amd-backbone-contacts/coffee/collections/contacts.coffee'>download</a></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="nx">define</span> <span class="p">[</span><span class="s1">&#39;use!underscore&#39;</span><span class="p">,</span> <span class="s1">&#39;use!backbone&#39;</span><span class="p">,</span> <span class="s1">&#39;models/contact&#39;</span><span class="p">,</span> <span class="s1">&#39;store&#39;</span><span class="p">],</span> <span class="nf">(_, Backbone, Contact, Store) -&gt;</span>
</span><span class='line'>  <span class="nv">Contacts = </span><span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span>
</span><span class='line'>    <span class="nv">model: </span><span class="nx">Contact</span>
</span><span class='line'>    <span class="nv">localStorage: </span><span class="k">new</span> <span class="nx">Store</span><span class="p">(</span><span class="s1">&#39;my-contacts&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="p">)</span>
</span><span class='line'>  <span class="k">new</span> <span class="nx">Contacts</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Backbone.sync标准CRUD REST接口</h2>

<p>如果采用标准的CRUD REST接口进行数据交换, 那就不用重载Backbone.sync方法, 只需要定义Collection的url属性(字符串或者方法)即可.</p>

<figure class='code'><figcaption><span> (contacts.coffee)</span> <a href='/examples/coffee-bbb-amd-backbone-rest-contacts/coffee/collections/contacts.coffee'>download</a></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="nx">define</span> <span class="p">[</span><span class="s1">&#39;underscore&#39;</span><span class="p">,</span> <span class="s1">&#39;backbone&#39;</span><span class="p">,</span> <span class="s1">&#39;models/contact&#39;</span><span class="p">],</span> <span class="nf">(_, Backbone, Contact) -&gt;</span>
</span><span class='line'>  <span class="nv">Contacts = </span><span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span>
</span><span class='line'>    <span class="nv">model: </span><span class="nx">Contact</span>
</span><span class='line'>    <span class="nv">url: </span><span class="s1">&#39;http://xiaocong.herokuapp.com/contacts/&#39;</span>
</span><span class='line'>    <span class="nv">parse: </span><span class="nf">(resp) -&gt;</span>
</span><span class='line'>      <span class="nx">resp</span><span class="p">.</span><span class="nx">results</span>
</span><span class='line'>  <span class="p">)</span>
</span><span class='line'>  <span class="k">new</span> <span class="nx">Contacts</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>其中<code>http://xiaocong.herokuapp.com/contacts/</code>实现了标准的CRUD REST接口:</p>

<ul>
<li><strong>POST</strong> /contacts 生成一个新的地址本记录, 并返回带有新生成的id的地址本数据, 供客户端更新model的id.</li>
<li><strong>GET</strong> /contacts 获取所有地址本数据, 由于Collection对象需要的集合数组在返回的JSON字符串的<code>results</code>属性中, 因此需要通过<code>parse</code>方法转换一下返回的结果.</li>
<li><strong>GET</strong> /contacts/id 获取指定id的地址本数据.</li>
<li><strong>PUT</strong> /contacts/id 更新指定id的地址本数据.</li>
<li><strong>DELETE</strong> /contacts/id 删除指定id的地址本数据</li>
</ul>


<p><a href="/examples/coffee-bbb-amd-backbone-rest-contacts/index.html">使用该CRUD REST接口的演示</a>.</p>

<p>下面是托管在<a href="http://www.heroku.com">heroku</a>上的该REST接口的python源代码:</p>

<ul>
<li>使用<a href="http://bottlepy.org/docs/dev/">bottle</a>微型web框架实现HTTP路由管理</li>
<li>使用<a href="http://www.sqlalchemy.org/">sqlalchemy</a>实现数据库的持续化存储</li>
<li>使用<a href="http://www.gevent.org/">gevent</a>实现HTTP并发服务</li>
<li>通过<code>Access-Control-Allow-Origin</code>实现跨域调用</li>
</ul>


<figure class='code'><figcaption><span>app.py</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">from</span> <span class="nn">gevent</span> <span class="kn">import</span> <span class="n">monkey</span><span class="p">;</span> <span class="n">monkey</span><span class="o">.</span><span class="n">patch_all</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="kn">from</span> <span class="nn">bottle</span> <span class="kn">import</span> <span class="n">Bottle</span><span class="p">,</span> <span class="n">route</span><span class="p">,</span> <span class="n">get</span><span class="p">,</span> <span class="n">post</span><span class="p">,</span> <span class="n">put</span><span class="p">,</span> <span class="n">delete</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">run</span><span class="p">,</span> <span class="n">static_file</span><span class="p">,</span> <span class="n">HTTPError</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">bottle.ext</span> <span class="kn">import</span> <span class="n">sqlalchemy</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span><span class="p">,</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">String</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">sqlalchemy.ext.declarative</span> <span class="kn">import</span> <span class="n">declarative_base</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">sessionmaker</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">sqlalchemy.exc</span> <span class="kn">import</span> <span class="n">SQLAlchemyError</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">os</span>
</span><span class='line'>
</span><span class='line'><span class="n">app</span> <span class="o">=</span> <span class="n">Bottle</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">hello</span><span class="p">():</span>
</span><span class='line'>    <span class="k">return</span> <span class="s">&quot;APIs for demo!&quot;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="n">Base</span> <span class="o">=</span> <span class="n">declarative_base</span><span class="p">()</span>
</span><span class='line'><span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&quot;SHARED_DATABASE_URL&quot;</span><span class="p">],</span> <span class="n">echo</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span><span class='line'><span class="n">create_session</span> <span class="o">=</span> <span class="n">sessionmaker</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Contact</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
</span><span class='line'>    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s">&quot;contact&quot;</span>
</span><span class='line'>    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">(</span><span class="s">&#39;contact_id_seq&#39;</span><span class="p">),</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span><span class='line'>    <span class="n">name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">))</span>
</span><span class='line'>    <span class="n">email</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">64</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">email</span><span class="p">):</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>        <span class="k">return</span> <span class="s">&quot;&lt;Contact(&#39;</span><span class="si">%d</span><span class="s">&#39;, &#39;</span><span class="si">%s</span><span class="s">&#39;, &#39;</span><span class="si">%s</span><span class="s">&#39;)&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">contactsApp</span> <span class="o">=</span> <span class="n">Bottle</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="nd">@contactsApp.hook</span><span class="p">(</span><span class="s">&quot;after_request&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">crossDomianHook</span><span class="p">():</span>
</span><span class='line'>    <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&quot;Access-Control-Allow-Origin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;*&quot;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="nd">@contactsApp.route</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="s">&quot;/&quot;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s">&quot;OPTIONS&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">options1</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">options</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="nd">@contactsApp.route</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="s">&quot;/:id&quot;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s">&quot;OPTIONS&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">options2</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">options</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">options</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
</span><span class='line'>    <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&quot;Access-Control-Allow-Methods&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;GET, POST, PUT, DELETE&quot;</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;Access-Control-Request-Headers&quot;</span><span class="p">):</span>
</span><span class='line'>        <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&quot;Access-Control-Allow-Headers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&quot;Access-Control-Request-Headers&quot;</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="nd">@contactsApp.post</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">createContact</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
</span><span class='line'>    <span class="sd">&#39;&#39;&#39;Create contact&#39;&#39;&#39;</span>
</span><span class='line'>    <span class="n">contact</span> <span class="o">=</span> <span class="n">Contact</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s">&quot;name&quot;</span><span class="p">],</span> <span class="n">email</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s">&quot;email&quot;</span><span class="p">])</span>
</span><span class='line'>    <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">contact</span><span class="p">)</span>
</span><span class='line'>    <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">{</span><span class="s">&quot;id&quot;</span><span class="p">:</span> <span class="n">contact</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;name&quot;</span><span class="p">:</span> <span class="n">contact</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;email&quot;</span><span class="p">:</span> <span class="n">contact</span><span class="o">.</span><span class="n">email</span><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="nd">@contactsApp.get</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">getAllContacts</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
</span><span class='line'>    <span class="sd">&#39;&#39;&#39;Retrieve all contacts&#39;&#39;&#39;</span>
</span><span class='line'>    <span class="n">contacts</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Contact</span><span class="p">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">{</span><span class="s">&quot;results&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s">&quot;id&quot;</span><span class="p">:</span><span class="n">contact</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;name&quot;</span><span class="p">:</span><span class="n">contact</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;email&quot;</span><span class="p">:</span><span class="n">contact</span><span class="o">.</span><span class="n">email</span><span class="p">}</span> <span class="k">for</span> <span class="n">contact</span> <span class="ow">in</span> <span class="n">contacts</span><span class="p">]}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="nd">@contactsApp.get</span><span class="p">(</span><span class="s">&quot;/:id&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">getContact</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">db</span><span class="p">):</span>
</span><span class='line'>    <span class="sd">&#39;&#39;&#39;Retrieve specified contact with id&#39;&#39;&#39;</span>
</span><span class='line'>    <span class="n">contact</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Contact</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">contact</span><span class="p">:</span>
</span><span class='line'>        <span class="k">return</span> <span class="p">{</span><span class="s">&quot;id&quot;</span><span class="p">:</span> <span class="n">contact</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;name&quot;</span><span class="p">:</span> <span class="n">contact</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;email&quot;</span><span class="p">:</span> <span class="n">contact</span><span class="o">.</span><span class="n">email</span><span class="p">}</span>
</span><span class='line'>    <span class="k">raise</span> <span class="n">HTTPError</span><span class="p">(</span><span class="mi">404</span><span class="p">,</span> <span class="s">&quot;Contact not found.&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="nd">@contactsApp.put</span><span class="p">(</span><span class="s">&quot;/:id&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">updateContact</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">db</span><span class="p">):</span>
</span><span class='line'>    <span class="sd">&#39;&#39;&#39;Update contact&#39;&#39;&#39;</span>
</span><span class='line'>    <span class="n">session</span> <span class="o">=</span> <span class="n">create_session</span><span class="p">()</span>
</span><span class='line'>    <span class="k">try</span><span class="p">:</span>
</span><span class='line'>        <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Contact</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s">&quot;name&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s">&quot;name&quot;</span><span class="p">],</span> <span class="s">&quot;email&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s">&quot;email&quot;</span><span class="p">]})</span>
</span><span class='line'>        <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span class='line'>    <span class="k">except</span> <span class="n">SQLAlchemyError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
</span><span class='line'>        <span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
</span><span class='line'>        <span class="k">raise</span> <span class="n">HTTPError</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="s">&quot;Database Error&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span class='line'>    <span class="k">finally</span><span class="p">:</span>
</span><span class='line'>        <span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="nd">@contactsApp.delete</span><span class="p">(</span><span class="s">&quot;/:id&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">deleteContact</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">db</span><span class="p">):</span>
</span><span class='line'>    <span class="sd">&#39;&#39;&#39;Delete contact&#39;&#39;&#39;</span>
</span><span class='line'>    <span class="n">session</span> <span class="o">=</span> <span class="n">create_session</span><span class="p">()</span>
</span><span class='line'>    <span class="k">try</span><span class="p">:</span>
</span><span class='line'>        <span class="n">contact</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Contact</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</span><span class='line'>        <span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">contact</span><span class="p">)</span>
</span><span class='line'>        <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span class='line'>    <span class="k">except</span> <span class="n">SQLAlchemyError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
</span><span class='line'>        <span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
</span><span class='line'>        <span class="k">raise</span> <span class="n">HTTPError</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="s">&quot;Database Error&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span class='line'>    <span class="k">finally</span><span class="p">:</span>
</span><span class='line'>        <span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="n">sqlalchemyplugin</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">Plugin</span><span class="p">(</span><span class="n">engine</span><span class="p">,</span> <span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span><span class='line'><span class="n">contactsApp</span><span class="o">.</span><span class="n">install</span><span class="p">(</span><span class="n">sqlalchemyplugin</span><span class="p">)</span>
</span><span class='line'><span class="n">app</span><span class="o">.</span><span class="n">mount</span><span class="p">(</span><span class="s">&quot;/contacts&quot;</span><span class="p">,</span> <span class="n">contactsApp</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
</span><span class='line'>    <span class="n">port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;PORT&quot;</span><span class="p">,</span> <span class="mi">5000</span><span class="p">))</span>
</span><span class='line'>    <span class="n">run</span><span class="p">(</span><span class="n">app</span><span class="o">=</span><span class="n">app</span><span class="p">,</span> <span class="n">server</span><span class="o">=</span><span class="s">&quot;gevent&quot;</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s">&quot;0.0.0.0&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">,</span> <span class="n">reloader</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>



</div>
 </div>

  
  <div class="post"> <div class="post-header">
  
    <h1 class="post-title">
      <a href="/blog/2012/06/15/beautiful-coffee-script/">美妙的Coffee-Script</a>
    </h1>
  
  








  


<time datetime="2012-06-15T14:36:00+08:00" pubdate data-updated="true">Jun 15<span>th</span>, 2012</time>
</div>

<div class="post-content"><p>JavaScript是标准的函数式动态语言, 但却有Java的语法. 用Java的语法写JavaScript的代码, 就好比穿着西装进行散打, 的确很让人别扭.</p>

<p>CoffeeScript对JavaScript的改造刚好切中要害, 用Ruby/Python的语法重新塑造了JavaScript, 抛弃掉Java语法上繁琐的要求, 让人可以用更简洁的方式写出优雅, 可读性更好的语句.</p>

<h2>简洁</h2>

<p>简洁意味着花更少的时间进行<em>coding</em>. 难道不是么? 我相信程序员都愿意去做真正意义的编程, 而不是枯燥地敲键盘<em>coding</em>.</p>

<p>大家可以对比一下CoffeeScript和JavaScript的语法, 看看CoffeeScript的简洁:</p>

<ul>
<li><a href="http://coffeescript.org/#literals">函数</a></li>
<li><a href="http://coffeescript.org/#conditionals">条件</a></li>
<li><a href="http://coffeescript.org/#splats">参数展开</a></li>
<li><a href="http://coffeescript.org/#loops">循环和列表推导</a></li>
<li><a href="http://coffeescript.org/#slices">数组切片</a></li>
<li><a href="http://coffeescript.org/#classes">类和继承</a></li>
<li><a href="http://coffeescript.org/#destructuring">析构赋值</a></li>
</ul>


<p>CoffeeScript的平均代码量估计不超过等价JavaScript代码量的50%.</p>

<!--more-->


<h2>优雅</h2>

<p>Coffee的代码看起来让人赏心悦目, 如同看诗一样:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="c1"># Assignment:</span>
</span><span class='line'><span class="nv">number   = </span><span class="mi">42</span>
</span><span class='line'><span class="nv">opposite = </span><span class="kc">true</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Conditions:</span>
</span><span class='line'><span class="nv">number = </span><span class="o">-</span><span class="mi">42</span> <span class="k">if</span> <span class="nx">opposite</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Functions:</span>
</span><span class='line'><span class="nv">square = </span><span class="nf">(x) -&gt;</span> <span class="nx">x</span> <span class="o">*</span> <span class="nx">x</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Arrays:</span>
</span><span class='line'><span class="nv">list = </span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Objects:</span>
</span><span class='line'><span class="nv">math =</span>
</span><span class='line'>  <span class="nv">root: </span>  <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span>
</span><span class='line'>  <span class="nv">square: </span><span class="nx">square</span>
</span><span class='line'>  <span class="nv">cube: </span>  <span class="nf">(x) -&gt;</span> <span class="nx">x</span> <span class="o">*</span> <span class="nx">square</span> <span class="nx">x</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Splats:</span>
</span><span class='line'><span class="nv">race = </span><span class="nf">(winner, runners...) -&gt;</span>
</span><span class='line'>  <span class="nx">print</span> <span class="nx">winner</span><span class="p">,</span> <span class="nx">runners</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Existence:</span>
</span><span class='line'><span class="nx">alert</span> <span class="s2">&quot;I knew it!&quot;</span> <span class="k">if</span> <span class="nx">elvis</span><span class="o">?</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Array comprehensions:</span>
</span><span class='line'><span class="nv">cubes = </span><span class="p">(</span><span class="nx">math</span><span class="p">.</span><span class="nx">cube</span> <span class="nx">num</span> <span class="k">for</span> <span class="nx">num</span> <span class="k">in</span> <span class="nx">list</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>同样的代码翻译成JavaScript代码, 看起来的心情可能就不一样了:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">cubes</span><span class="p">,</span> <span class="nx">list</span><span class="p">,</span> <span class="nx">math</span><span class="p">,</span> <span class="nx">num</span><span class="p">,</span> <span class="nx">number</span><span class="p">,</span> <span class="nx">opposite</span><span class="p">,</span> <span class="nx">race</span><span class="p">,</span> <span class="nx">square</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">__slice</span> <span class="o">=</span> <span class="p">[].</span><span class="nx">slice</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="nx">number</span> <span class="o">=</span> <span class="mi">42</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="nx">opposite</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="nx">opposite</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">number</span> <span class="o">=</span> <span class="o">-</span><span class="mi">42</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nx">square</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">x</span> <span class="o">*</span> <span class="nx">x</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="nx">list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="nx">math</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">root</span><span class="o">:</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">square</span><span class="o">:</span> <span class="nx">square</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">cube</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">x</span> <span class="o">*</span> <span class="nx">square</span><span class="p">(</span><span class="nx">x</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="nx">race</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">runners</span><span class="p">,</span> <span class="nx">winner</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">winner</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">runners</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">&lt;=</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">?</span> <span class="nx">__slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="p">[];</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">print</span><span class="p">(</span><span class="nx">winner</span><span class="p">,</span> <span class="nx">runners</span><span class="p">);</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">elvis</span> <span class="o">!==</span> <span class="s2">&quot;undefined&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">elvis</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;I knew it!&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nx">cubes</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">_i</span><span class="p">,</span> <span class="nx">_len</span><span class="p">,</span> <span class="nx">_results</span><span class="p">;</span>
</span><span class='line'>  <span class="nx">_results</span> <span class="o">=</span> <span class="p">[];</span>
</span><span class='line'>  <span class="k">for</span> <span class="p">(</span><span class="nx">_i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">_len</span> <span class="o">=</span> <span class="nx">list</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">_i</span> <span class="o">&lt;</span> <span class="nx">_len</span><span class="p">;</span> <span class="nx">_i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">num</span> <span class="o">=</span> <span class="nx">list</span><span class="p">[</span><span class="nx">_i</span><span class="p">];</span>
</span><span class='line'>    <span class="nx">_results</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">math</span><span class="p">.</span><span class="nx">cube</span><span class="p">(</span><span class="nx">num</span><span class="p">));</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">_results</span><span class="p">;</span>
</span><span class='line'><span class="p">})();</span>
</span></code></pre></td></tr></table></div></figure>


<p>一个是诗一般的代码, 另一个就是代码, 看起来心情能一样么?</p>

<h2>可读性</h2>

<p>有谁愿意一次又一次地花时间琢磨<code>for</code>循环到<code>n</code>还是<code>n-1</code>结束呢? 这种琢磨对于软件来说到底有多大意思? 我们是按照自然语言的方式进行思维, 如果也按照自然语言的方式写代码, 那我们的大脑就不会花无谓的时间进行翻译了.</p>

<p>看看下面CoffeeScript的代码， 是不是读完代码就明白了这段代码的意思?</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="nv">foods = </span><span class="p">[</span><span class="s1">&#39;broccoli&#39;</span><span class="p">,</span> <span class="s1">&#39;spinach&#39;</span><span class="p">,</span> <span class="s1">&#39;chocolate&#39;</span><span class="p">]</span>
</span><span class='line'><span class="nx">eat</span> <span class="nx">food</span> <span class="k">for</span> <span class="nx">food</span> <span class="k">in</span> <span class="nx">foods</span> <span class="k">when</span> <span class="nx">food</span> <span class="o">isnt</span> <span class="s1">&#39;chocolate&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>然后再对照等价的JavaScript代码, 读代码的过程中, 不知道你的大脑需要花多长时间进行翻译?</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">food</span><span class="p">,</span> <span class="nx">foods</span><span class="p">,</span> <span class="nx">_i</span><span class="p">,</span> <span class="nx">_len</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="nx">foods</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;broccoli&#39;</span><span class="p">,</span> <span class="s1">&#39;spinach&#39;</span><span class="p">,</span> <span class="s1">&#39;chocolate&#39;</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="k">for</span> <span class="p">(</span><span class="nx">_i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">_len</span> <span class="o">=</span> <span class="nx">foods</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">_i</span> <span class="o">&lt;</span> <span class="nx">_len</span><span class="p">;</span> <span class="nx">_i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">food</span> <span class="o">=</span> <span class="nx">foods</span><span class="p">[</span><span class="nx">_i</span><span class="p">];</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="nx">food</span> <span class="o">!==</span> <span class="s1">&#39;chocolate&#39;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">eat</span><span class="p">(</span><span class="nx">food</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>效率</h2>

<p>代码逻辑需要技巧, 而程序逻辑需要智慧. CoffeeScript尽可能地在语法上解决代码逻辑, 而让你的大脑更多地去思考程序逻辑.</p>

<h2>示例</h2>

<p>本示例将地址本的JavaScript的实现改写为CoffeeScript进行实现, 同时增加了Grunt的CoffeeScript编译任务, 主要改动包括:</p>

<ul>
<li>coffee源代码目录: coffee</li>
<li>grunt coffee编译任务: tasks/coffee.js</li>
<li>更改grunt配置文件以支持coffee的编译: grunt.js</li>
</ul>


<p>下面的链接你可以找到所有的源代码:</p>

<ul>
<li><a href="https://github.com/xiaocong/xiaocong.github.com/tree/source/source/examples/bbb-amd-backbone-contacts/">地址本-JavaScript源码</a></li>
<li><a href="https://github.com/xiaocong/xiaocong.github.com/tree/source/source/examples/coffee-bbb-amd-backbone-contacts/">地址本-CoffeeScript源码</a></li>
<li><a href="/examples/coffee-bbb-amd-backbone-contacts/index.html">地址本-CoffeeScript演示</a></li>
</ul>


<h2>参考</h2>

<ul>
<li><a href="http://coffeescript.org/">CoffeeScript官网</a></li>
<li><a href="http://arcturo.github.com/library/coffeescript/">The Little Book on CoffeeScript</a></li>
<li><a href="http://autotelicum.github.com/Smooth-CoffeeScript/">Smooth CoffeeScript</a></li>
</ul>

</div>
 </div>

  
  <div class="post"> <div class="post-header">
  
    <h1 class="post-title">
      <a href="/blog/2012/06/13/python-mixin-and-mro/">Python Mixin and MRO</a>
    </h1>
  
  








  


<time datetime="2012-06-13T23:09:00+08:00" pubdate data-updated="true">Jun 13<span>th</span>, 2012</time>
</div>

<div class="post-content"><h2>什么是 mixin ?</h2>

<blockquote><p>In object-oriented programming languages, a mixin is a class that provides a certain functionality to be inherited or just reused by a subclass, while not meant for instantiation (the generation of objects of that class). Mixins are synonymous with abstract base classes. Inheriting from a mixin is not a form of specialization but is rather a means of collecting functionality. A class or object may &#8220;inherit&#8221; most or all of its functionality from one or more mixins, therefore mixins can be thought of as a mechanism of multiple inheritance.</p><footer><strong>Wikipedia</strong> <cite><a href='http://en.wikipedia.org/wiki/Mixin'>Mixin</a></cite></footer></blockquote>


<p>简单的说, mixin 是一种类的多继承的机制.</p>

<h2>什么时候需要 mixin ?</h2>

<p>就如<a href="http://stackoverflow.com/questions/533631/what-is-a-mixin-and-why-are-they-useful">stackoveflow</a>
上的回答, 有两个主要的使用 mixin 的场景:</p>

<ul>
<li>你希望给一个类提供很多可选的特征(feature).</li>
<li>你希望在很多不同的类中使用一个特定的特征(feature).</li>
</ul>


<!--more-->


<p>例如, <a href="http://werkzeug.pocoo.org/docs/wrappers/">werkzeug</a> 的<code>request</code>, <code>response</code>系统.
我们可以实现简单<code>request</code>如下:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">from</span> <span class="nn">werkzeug</span> <span class="kn">import</span> <span class="n">BaseRequest</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Request</span><span class="p">(</span><span class="n">BaseRequest</span><span class="p">):</span>
</span><span class='line'>    <span class="k">pass</span>
</span></code></pre></td></tr></table></div></figure>


<p>如果我们希望支持<code>accept header</code>, 可以这样实现:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">from</span> <span class="nn">werkzeug</span> <span class="kn">import</span> <span class="n">BaseRequest</span><span class="p">,</span> <span class="n">AcceptMixin</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Request</span><span class="p">(</span><span class="n">BaseRequest</span><span class="p">,</span> <span class="n">AcceptMixin</span><span class="p">):</span>
</span><span class='line'>    <span class="k">pass</span>
</span></code></pre></td></tr></table></div></figure>


<p>如果我们希望<code>request</code>对象支持<code>accept header</code>, <code>etags</code>, <code>authentication</code>, <code>user agent</code>, 可以这样实现:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">from</span> <span class="nn">werkzeug</span> <span class="kn">import</span> <span class="n">BaseRequest</span><span class="p">,</span> <span class="n">AcceptMixin</span><span class="p">,</span> <span class="n">ETagRequestMixin</span><span class="p">,</span> <span class="n">UserAgentMixin</span><span class="p">,</span> <span class="n">AuthorizationMixin</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Request</span><span class="p">(</span><span class="n">BaseRequest</span><span class="p">,</span> <span class="n">AcceptMixin</span><span class="p">,</span> <span class="n">ETagRequestMixin</span><span class="p">,</span> <span class="n">UserAgentMixin</span><span class="p">,</span> <span class="n">AuthorizationMixin</span><span class="p">):</span>
</span><span class='line'>    <span class="k">pass</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Mixin 的实现</h2>

<p>假定我们有下面两个类需要mixin:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">class</span> <span class="nc">Base</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span class='line'>    <span class="k">pass</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">FeatureMixin</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span class='line'>    <span class="k">pass</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>直接定义一个类 mixin 所有的 feature</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">class</span> <span class="nc">MyClass</span><span class="p">(</span><span class="n">Base</span><span class="p">,</span> <span class="n">FeatureMixin</span><span class="p">):</span>
</span><span class='line'>    <span class="k">pass</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>通过闭包动态定义类来实现 Mixin</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">def</span> <span class="nf">mixin</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">mixin</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
</span><span class='line'>    <span class="k">class</span> <span class="nc">MixinClass</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">mixin</span><span class="p">):</span>
</span><span class='line'>        <span class="k">pass</span>
</span><span class='line'>    <span class="n">MixinClass</span><span class="o">.</span><span class="n">__name__</span> <span class="o">=</span> <span class="n">name</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">MixinClass</span>
</span><span class='line'>
</span><span class='line'><span class="n">MyClass</span> <span class="o">=</span> <span class="n">mixin</span><span class="p">(</span><span class="n">Base</span><span class="p">,</span> <span class="n">FeatureMixin</span><span class="p">,</span> <span class="s">&#39;MyClass&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>使用<code>type</code>动态构造类来实现 Mixin</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">MyClass</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="s">&#39;MyClass&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">Base</span><span class="p">,</span> <span class="n">FeatureMixin</span><span class="p">),</span> <span class="p">{})</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>更改<code>__bases__</code>来实现 Mixin. <em>只能 mixin <code>classic class</code></em></li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">class</span> <span class="nc">Base</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span class='line'>    <span class="k">pass</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">FeatureMixin</span><span class="p">:</span> <span class="c"># not inherite from object</span>
</span><span class='line'>    <span class="k">pass</span>
</span><span class='line'>
</span><span class='line'><span class="n">Base</span><span class="o">.</span><span class="n">__bases__</span> <span class="o">+=</span> <span class="p">(</span><span class="n">FeatureMixin</span><span class="p">,)</span> <span class="c"># then Base should have FeatureMixin</span>
</span></code></pre></td></tr></table></div></figure>


<h2>MRO(Method Resolution Order)</h2>

<blockquote><p>In object-oriented programming languages with multiple inheritance, the diamond problem (sometimes referred to as the &#8220;deadly diamond of death&#8221;) is an ambiguity that arises when two classes B and C inherit from A, and class D inherits from both B and C. If D calls a method defined in A (and does not override the method), and B and C have overridden that method differently, then from which class does it inherit: B, or C?</p><footer><strong>Wikipedia</strong> <cite><a href='http://en.wikipedia.org/wiki/Diamond_problem'>Diamond Problem</a></cite></footer></blockquote>


<p>多继承时, 运行环境必须知道调用哪一个父类的方法. Python2.3开始采用<code>C3</code>方法解析顺序(<a href="http://www.python.org/getit/releases/2.3/mro/">Method Resolution Order</a>, 简称MRO)来动态解析调用的方法.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">O</span> <span class="o">=</span> <span class="nb">object</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="n">O</span><span class="p">):</span> <span class="k">pass</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="k">class</span> <span class="nc">B</span><span class="p">(</span><span class="n">O</span><span class="p">):</span> <span class="k">pass</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="k">class</span> <span class="nc">X</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">):</span> <span class="k">pass</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="k">class</span> <span class="nc">Y</span><span class="p">(</span><span class="n">B</span><span class="p">,</span><span class="n">A</span><span class="p">):</span> <span class="k">pass</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">X</span><span class="o">.</span><span class="n">mro</span><span class="p">()</span>
</span><span class='line'><span class="p">[</span><span class="o">&lt;</span><span class="k">class</span> <span class="err">&#39;</span><span class="nc">__main__</span><span class="o">.</span><span class="n">X</span><span class="s">&#39;&gt;, &lt;class &#39;</span><span class="n">__main__</span><span class="o">.</span><span class="n">A</span><span class="s">&#39;&gt;, &lt;class &#39;</span><span class="n">__main__</span><span class="o">.</span><span class="n">B</span><span class="s">&#39;&gt;, &lt;type &#39;</span><span class="nb">object</span><span class="s">&#39;&gt;]</span>
</span><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="n">Y</span><span class="o">.</span><span class="n">mro</span><span class="p">()</span>
</span><span class='line'><span class="p">[</span><span class="o">&lt;</span><span class="k">class</span> <span class="err">&#39;</span><span class="nc">__main__</span><span class="o">.</span><span class="n">Y</span><span class="s">&#39;&gt;, &lt;class &#39;</span><span class="n">__main__</span><span class="o">.</span><span class="n">B</span><span class="s">&#39;&gt;, &lt;class &#39;</span><span class="n">__main__</span><span class="o">.</span><span class="n">A</span><span class="s">&#39;&gt;, &lt;type &#39;</span><span class="nb">object</span><span class="s">&#39;&gt;]</span>
</span></code></pre></td></tr></table></div></figure>


<p>参照上面代码执行的结果, 我们可以看出, <code>class X</code>的 MRO 是 <code>&lt;class '__main__.X'&gt;, &lt;class '__main__.A'&gt;, &lt;class '__main__.B'&gt;, &lt;type 'object'&gt;</code>.
当我们调用<code>X</code>实例对象的某个方法, 运行环境会按照<code>X, A, B, object</code>顺序解析该方法. 越左边的越优先,
也就是说如果只有<code>A</code>, <code>B</code>定义了这个方法, 系统会选择最先解析到的方法, 也就是<code>A</code>的方法定义.
同样, <code>class Y</code>的 MRO 是 <code>&lt;class '__main__.Y'&gt;, &lt;class '__main__.B'&gt;, &lt;class '__main__.A'&gt;, &lt;type 'object'&gt;</code>,
对于<code>Y</code>来说, <code>B</code>的方法要优先于<code>A</code>进行解析.</p>

<p>上面定义的类<code>X</code>和<code>Y</code>对<code>A</code>和<code>B</code>的方法解析顺序是刚好相反的, 如果有一个类继承于<code>X</code>和<code>Y</code>会出现什么结果?</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;&gt;&gt;</span> <span class="k">class</span> <span class="nc">M</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">):</span> <span class="k">pass</span>
</span><span class='line'><span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
</span><span class='line'>  <span class="n">File</span> <span class="s">&quot;&lt;stdin&gt;&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
</span><span class='line'><span class="ne">TypeError</span><span class="p">:</span> <span class="n">Error</span> <span class="n">when</span> <span class="n">calling</span> <span class="n">the</span> <span class="n">metaclass</span> <span class="n">bases</span>
</span><span class='line'>    <span class="n">Cannot</span> <span class="n">create</span> <span class="n">a</span> <span class="n">consistent</span> <span class="n">method</span> <span class="n">resolution</span>
</span><span class='line'><span class="n">order</span> <span class="p">(</span><span class="n">MRO</span><span class="p">)</span> <span class="k">for</span> <span class="n">bases</span> <span class="n">B</span><span class="p">,</span> <span class="n">A</span>
</span></code></pre></td></tr></table></div></figure>


<p>上面的错误说明, 类的继承必须保持一致的 MRO. 由于基类<code>X</code>和<code>Y</code>的 MRO 有冲突, 因此我们不可能从<code>X</code>和<code>Y</code>继承另外一个类.</p>

<p>关于 MRO 的算法可以参考官网上的<a href="http://www.python.org/getit/releases/2.3/mro/">Python 2.3 方法解析顺序</a>.</p>
</div>
 </div>

  
  <div class="post"> <div class="post-header">
  
    <h1 class="post-title">
      <a href="/blog/2012/06/12/python-metaclass/">Metaclasses in Python</a>
    </h1>
  
  








  


<time datetime="2012-06-12T22:26:00+08:00" pubdate data-updated="true">Jun 12<span>th</span>, 2012</time>
</div>

<div class="post-content"><h2>什么是 metaclass ?</h2>

<blockquote><p>In object-oriented programming, a metaclass is a class whose instances are <br/>classes. Just as an ordinary class defines the behavior of certain objects, a<br/>metaclass defines the behavior of certain classes and their instances.</p><footer><strong>Wikipedia</strong> <cite><a href='http://en.wikipedia.org/wiki/Metaclass'>Metaclass</a></cite></footer></blockquote>


<p>简单的说, metaclass 就是 class 类型对象的 class, metaclass 的实例对象是 class 类型对象.</p>

<h2>metaclass 能用来做什么 ?</h2>

<p>我们就可以用 metaclass 来动态生成或者更改 class 的定义.</p>

<p>下面分别是通过传统 class 方式以及 metaclass 动态定义类 <code>A</code></p>

<figure class='code'><figcaption><span>传统 class 方式定于类 A</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span class='line'>    <span class="n">a</span> <span class="o">=</span> <span class="s">&#39;I am a string.&#39;</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>metaclass 动态定义类 `A`</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">A</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="s">&#39;A&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nb">object</span><span class="p">,),</span> <span class="p">{</span><span class="s">&#39;a&#39;</span><span class="p">:</span> <span class="s">&#39;I am a string.&#39;</span><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<p>上面我们通过<code>type</code>类的实例化来生成类<code>A</code>, 如果我们想自定义类的生成, 我们可以以<code>type</code>类为基
类派生出自定义的 metaclass.</p>

<p><em>注: 本文所有代码在 python2.6 下能执行通过, 不能确保在 python3 下无误.</em></p>

<!-- more -->


<h2>继承<code>type</code>类实现 metaclass</h2>

<p>我们可以从<code>type</code>类派生出新的 metaclass, 然后通过重新实现<code>__new__</code>, <code>__init__</code>,
<code>__call__</code>来实现类或者类实例的生成.</p>

<figure class='code'><figcaption><span>Meta类 meta.py</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">class</span> <span class="nc">Meta</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>        <span class="k">print</span> <span class="s">&#39;Enter Meta.__call__: &#39;</span><span class="p">,</span> <span class="bp">self</span>
</span><span class='line'>        <span class="n">obj</span> <span class="o">=</span> <span class="nb">type</span><span class="o">.</span><span class="n">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span class='line'>        <span class="k">print</span> <span class="s">&#39;Exit Meta.__call__: &#39;</span><span class="p">,</span> <span class="n">obj</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">obj</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">metacls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">dictionary</span><span class="p">):</span>
</span><span class='line'>        <span class="k">print</span> <span class="s">&#39;Enter Meta.__new__:&#39;</span><span class="p">,</span> <span class="n">metacls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">dictionary</span>
</span><span class='line'>        <span class="n">newClass</span> <span class="o">=</span> <span class="nb">type</span><span class="o">.</span><span class="n">__new__</span><span class="p">(</span><span class="n">metacls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">dictionary</span><span class="p">)</span>
</span><span class='line'>        <span class="k">print</span> <span class="s">&#39;Exit Meta.__new__: &#39;</span><span class="p">,</span> <span class="n">newClass</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">newClass</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">dictionary</span><span class="p">):</span>
</span><span class='line'>        <span class="k">print</span> <span class="s">&#39;Enter Meta.__init__: &#39;</span><span class="p">,</span> <span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">dictionary</span>
</span><span class='line'>        <span class="nb">super</span><span class="p">(</span><span class="n">Meta</span><span class="p">,</span> <span class="n">cls</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">dictionary</span><span class="p">)</span>
</span><span class='line'>        <span class="k">print</span> <span class="s">&#39;Exit Meta.__init__&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span> <span class="s">&#39;Create class A&#39;</span>
</span><span class='line'><span class="n">A</span> <span class="o">=</span> <span class="n">Meta</span><span class="p">(</span><span class="s">&#39;A&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nb">object</span><span class="p">,),</span> <span class="p">{})</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span>
</span><span class='line'><span class="k">print</span> <span class="s">&#39;Create instance of class A&#39;</span>
</span><span class='line'><span class="n">A</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>当我们运行上述的python文件, 会得到下面的输出结果:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>python meta.py
</span><span class='line'>Create class A
</span><span class='line'>Enter Meta.__new__: &lt;class <span class="s1">&#39;__main__.Meta&#39;</span>&gt; A <span class="o">(</span>&lt;<span class="nb">type</span> <span class="s1">&#39;object&#39;</span>&gt;,<span class="o">)</span> <span class="o">{}</span>
</span><span class='line'>Exit Meta.__new__:  &lt;class <span class="s1">&#39;__main__.A&#39;</span>&gt;
</span><span class='line'>Enter Meta.__init__:  &lt;class <span class="s1">&#39;__main__.A&#39;</span>&gt; A <span class="o">(</span>&lt;<span class="nb">type</span> <span class="s1">&#39;object&#39;</span>&gt;,<span class="o">)</span> <span class="o">{}</span>
</span><span class='line'>Exit Meta.__init__
</span><span class='line'>
</span><span class='line'>Create instance of class A
</span><span class='line'>Enter Meta.__call__:  &lt;class <span class="s1">&#39;__main__.A&#39;</span>&gt;
</span><span class='line'>Exit Meta.__call__:  &lt;__main__.A object at 0xb76a9ccc&gt;
</span><span class='line'><span class="err">$</span>
</span></code></pre></td></tr></table></div></figure>


<p>通过上面的输出结果, 我们可以看出:</p>

<ul>
<li><code>Meta.__new__</code>是用来生成类<code>A</code>的<strong>类型对象</strong>, 我们可以在调用<code>type.__new__</code>之前更改
<code>dictionary</code>变量来增加/修改/删除新生成类<code>A</code>的成员变量/方法.</li>
<li><code>Meta.__new__</code>是在生成类<code>A</code>的<strong>类型对象</strong>后被调用类进行类<code>A</code>的初始化. 第一个参数<code>cls</code>
是已经生成的类<code>A</code>类型对象, 可以通过直接修改<code>cls</code>来修改类的定义, 例如增加成员变量.</li>
<li><code>Meta.__call__</code>是在生成类<code>A</code>的<strong>实例对象</strong>时被调用的, 通过调用<code>type.__call__</code>可以
生成该实例对象<code>obj</code>, 之后我们可以直接修改<code>obj</code>来实现实例对象的自定义.</li>
</ul>


<h2>如何使用 metaclass ?</h2>

<ul>
<li>我们可以直接调用<code>type</code>或者<code>Meta</code>来<em>动态</em>生成新的类型对象<code>A</code>:</li>
</ul>


<figure class='code'><figcaption><span>实例化Meta来生成新的类</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">A</span> <span class="o">=</span> <span class="n">Meta</span><span class="p">(</span><span class="s">&#39;A&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nb">object</span><span class="p">,),</span> <span class="p">{})</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>在定义类的时候, 重新指定该类的<code>__metaclass__</code>属性为<code>Meta</code>:</li>
</ul>


<figure class='code'><figcaption><span>构建类的__metaclass__</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span class='line'>    <span class="n">__metaclass__</span> <span class="o">=</span> <span class="n">Meta</span>
</span><span class='line'>    <span class="c"># other member variables/methods definition</span>
</span></code></pre></td></tr></table></div></figure>


<p>注意: 定义<code>__metaclass__</code>生成的类<code>A</code>会增加<code>_A__metaclass</code>成员变量, 在某些场景下需要
了解到这个区别.</p>

<h2>函数方式定义类的 metaclass</h2>

<p>类的<code>__metaclass__</code>可以是一个<code>type</code>类型的子类, 也可以是一个函数, 该函数接受三个参数:</p>

<ul>
<li><em>name</em>: 字符串类型, 表示新生成类型对象的名称</li>
<li><em>bases</em>: tuple类型, 新生成类型对象的父类列表</li>
<li><em>properties</em>: 字典类型, 新生成类型对象的属性</li>
</ul>


<p>该函数必须返回新生成的类型对象. 下面例子是一个简单实现:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">def</span> <span class="nf">meta_func</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">properties</span><span class="p">):</span>
</span><span class='line'>    <span class="c"># you can modify bases, properties here to overide class creation</span>
</span><span class='line'>    <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">properties</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span class='line'>    <span class="n">__metaclass__</span> <span class="o">=</span> <span class="n">meta_func</span>
</span></code></pre></td></tr></table></div></figure>


<h2>使用 metaclass 的案例</h2>

<ul>
<li>动态修改类的方法和属性, 例如给方法增加<code>decorator</code></li>
<li>类的序列化和反序列化</li>
<li>在生成类的时候进行接口检查和接口注册</li>
<li>对第三方库进行<code>monkey patch</code></li>
<li>生成代理类</li>
<li>动态mixin</li>
<li>控制实例对象的生成, 例如单体实例, 监控所有生成的实例对象</li>
</ul>


<p>搜索<a href="http://stackoverflow.com/search?tab=votes&amp;q=python%20metaclass">stackoverflow</a>
能找到大量使用 metaclass 的设计模式.</p>

<h2>使用 metaclass 的原则</h2>

<p>metaclass 会降低代码的可读性, 并且很多使用 metaclass 的场景都有替代方案, 因此必须牢记下面的
忠告:</p>

<blockquote><p>Metaclasses are deeper magic than 99% of users should ever worry about. If you wonder whether you need them, you don’t (the people who actually need them know with certainty that they need them, and don’t need an explanation about why).</p><footer><strong>Tim Peters</strong> <cite>Python Guru</cite></footer></blockquote>


<h2>参考</h2>

<ul>
<li><a href="http://gnosis.cx/publish/programming/metaclass_1.html">Metaclass Programming In Python</a></li>
<li><a href="http://en.wikipedia.org/wiki/Metaclass">Wikipedia: Metaclass</a></li>
<li><a href="http://www.vrplumber.com/programming/metaclasses.pdf">Python Metaclasses: Who? Why? When?</a></li>
</ul>

</div>
 </div>


<div id="pagination">
  
    <a class="prev" href="/blog/page/2/">&laquo;Previous</a>
  
  
</div>
 </div>
    <div id="footer">
  <div class="panels">
    <div class="license">
      <h2>License</h2>
      <p>如非特别声明，本 Blog 的文章由 Xiaocong He 创作，采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/">知识共享署名-非商业性使用-相同方式共享 3.0 Unported 许可协议</a>进行许可。</p>
    </div>

    <div class="posts">
      <h2>Recent Posts</h2>
      <ul>
        
          <li>
            <a href="/blog/2012/11/21/to-introduce-android-dropboxmanager-service/">介绍 Android DropBoxManager Service</a>
          </li>
        
          <li>
            <a href="/blog/2012/10/16/yeoman-a-new-javascript-build-tool/">Yeoman: 一个新的 javascript 构建工具</a>
          </li>
        
          <li>
            <a href="/blog/2012/10/09/use-backbone-dot-layoutmanager-to-assemble-layouts-with-backbone-views/">在Backbone项目中使用backbone.layoutmanager来组织页面布局</a>
          </li>
        
          <li>
            <a href="/blog/2012/08/09/what-you-should-know-for-spa-project/">开发SPA前端项目必须掌握什么知识?</a>
          </li>
        
          <li>
            <a href="/blog/2012/07/20/integrate-requirejs-slash-backbone-slash-jasmine-front-end-project-with-ci-using-bbb-slash-gruntjs/">Requirejs/Backbone/Jasmine前端项目和持续继承</a>
          </li>
        
      </ul>
    </div>

    <div class="douban">
      <h2>Reading</h2>
      
        <script type="text/javascript" src="http://www.douban.com/service/badge/xiaoconghe/?show=collection&amp;select=favorite&amp;n=8&amp;columns=4&amp;hidelogo=yes&amp;hideself=yes&amp;cat=book" ></script>
        <a href="http://www.douban.com/people/xiaoconghe" class="view-douban">xiaoconghe on douban.com&raquo;</a>
      
    </div>
  </div>

  <p class="powered">
    Powered by <a href="http://octopress.org">Octopress</a> and <a href="https://github.com/iwinux/compbits">Compbits</a>
  </p>
</div>

  </div> <!-- #wrapper end -->

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-32376813-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


  

<script type="text/javascript">
      var disqus_shortname = 'xiaocong';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>


  
<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>


  
  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>


  
  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>


</body>
</html>
